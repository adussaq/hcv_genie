var hcvGenie={};hcvGenie.findBands=function(){"use strict";var t,e,n,r,h,i,a,o,s,c,l,u,f,g,d,M,y,m=1e4,_=[76.2806,-35.5237,23.7941],x=75,w=x*x*4,p=16,v=10,b=.04,P=.020734842905516,S=.1160010024291,T=1.255947650078826,I=.003233394220093,G=.009150503777635,R=.254982069800913,A=.822512153640132,B=.02;return d=amd_ww.startWorkers({filename:"./js/colorDistanceWorker.min.js"}),M=amd_ww.startWorkers({filename:"./js/houghTransformWorker.min.js",num_workers:2}),y=amd_ww.startWorkers({filename:"./js/edgeDetectionWorker.min.js",num_workers:2}),l=function(t){var e;return e=JSON.parse(JSON.stringify(t)),e.sort(c),(e[Math.floor(e.length/2)]+e[Math.ceil(e.length/2)])/2},g=function(t,e){return function(n){var r,h=parseInt(t.join(""),2);return h=h.toString(36),r=n.hasOwnProperty(h)?n[h].replace(/GNT/g,"Genotype"):"unknown",e.genotype=r,r}},s=function(t,e,n){var r,h,i,a,o,s,c,l,u=0,f=t.x0,g=t.y0,d=t.width,M=t.height,y=t.theta;for(h=Math.atan2(M,d),l=h+y,n.fillStyle(e),r=0;r<2*Math.PI;r+=u)a=Math.cos(r),o=Math.sin(r),r>l&&r<=Math.PI-l||r>Math.PI+l&&r<=2*Math.PI-l?(i=Math.abs(M/(2*o)),s=r<Math.PI?r:r-Math.PI,c=r<Math.PI?0:Math.PI,u=Math.abs(Math.acos(Math.cos(s+.3/i))+c-r)):(i=Math.abs(d/(2*a)),r<Math.PI/2?(s=r,c=0):r<Math.PI?(s=r-Math.PI/2,c=Math.PI/2):r<1.5*Math.PI?(s=r-Math.PI,c=Math.PI):(s=r-1.5*Math.PI,c=1.5*Math.PI),u=Math.abs(Math.asin(Math.sin(s+.3/i))+c-r)),n.fillRect(Math.floor(i*Math.cos(r)+f+.1),Math.floor(i*Math.sin(r)+g+.1),1,1),u=Math.max(u,Math.PI/180);n.fillRect(Math.round(f),Math.round(g)-1,1,3),n.fillRect(Math.round(f)-1,Math.round(g),3,1)},t=function(t,e){var n,r,h,i,a,o,c,l,d,_,x=2,w=[],p=Math.PI/180,v=1.65,H=0,j=[];for(i=function(t,e){var n,r,h,i,a,o,s=0,c=0,l=0,u=0,g=0;for(a=t.linearArr.length,n=0;n<e.HTscore/500+1;n+=1)t.linearArr.push([e.y0,e.x0]);for(r=t.linearArr.length,n=0;r>n;n+=1)g+=t.linearArr[n][1];for(g=f(g/r),n=0;r>n;n+=1)o=t.linearArr[n][1],o+=g-.5>o?.5:o>g+.5?-.5:0,s+=t.linearArr[n][0]*o,u+=t.linearArr[n][0],c+=o,l+=t.linearArr[n][0]*t.linearArr[n][0];return s/=r,c/=r,u/=r,l/=r,l!==u*u&&a?(h=(s-c*u)/(l-u*u),h=(h*t.distances.length+Math.tan(t.theta))/(t.distances.length+1)):h=Math.tan(e.theta),i=c-h*u+h*t.y_shift-t.x_shift,t.m=h,t.intercept=i,t},a=function(t){var e,n,r,i,a,o=t.theta,s=t.x0,c=t.y0,l=t.width,u=t.height;return a=Math.ceil(100*(27.5-P)/(T/l+S/u))/100,e=Math.floor(1.15*u+c),r=Math.ceil(a*Math.cos(Math.min(Math.abs(o),Math.abs(Math.abs(o)-p)))+2*x),h=20+Math.tan(p+Math.abs(o))*r,n=Math.floor(s-l/2-h),i=Math.ceil(l+2*h),{x_shift_left:n,y_shift_down:e,width:i,height:r}},_=function(t,e,n){var r,h,i,a,o,s,c;for(i=Math.ceil(n.rect_width*v),r=Math.floor(t.x-i/2),o=Math.ceil(Math.sin(Math.abs(n.theta))*i/2+n.rect_height*(v-1)),h=t.y-o,a=Math.ceil(n.rect_height+2*o),s=[],0>r&&(i+=2*r,r=0),0>h&&(a+=2*h,h=0),a+h>n.y_max-1&&(h=a+2*h-(n.y_max-1),a=n.y_max-1-h),i+r>n.x_max-1&&(r=i+2*r-(n.x_max-1),i=n.x_max-1-r),c=r;i+r>c;c+=1)s.push([]),s[s.length-1]=e[c].slice(h,a+h);return{array:s,x_shift:r,y_shift:h}},c=function(t){return y.submit({array:t,non_maximum_suppression:1,for_hough:!1,roundDigit:m,minimum_edge:b})},o=function(e,n,r,h){var a;e.end||(a=_(e,n,r),s({x0:a.array.length/2+r.x_shift+a.x_shift,y0:a.array[0].length/2+r.y_shift+a.y_shift,height:a.array[0].length,theta:0,width:a.array.length},"#FFFFCC",t),M.submit({array:a.array,roundDigit:m}).then(function(n){var o,c,l;c=(n.y0+a.y_shift)/r.y_max*0,n.HTscore=f(n.HTscore/b/10),n.x0+=r.x_shift+a.x_shift,n.y0+=r.y_shift+a.y_shift,l=n.x0>r.x_origin+.5?.5:n.x0<r.x_origin-.5?-.5:0,o=Math.atan2(n.x0-r.x_origin+l,n.y0-r.y_origin),n.width=((r.greenRectangleScore+r.rectangleScore)*r.rect_width+n.width*n.HTscore)/(r.rectangleScore+r.greenRectangleScore+n.HTscore),n.height=((r.greenRectangleScore+r.rectangleScore)*r.rect_height+n.height*n.HTscore)/(r.rectangleScore+r.greenRectangleScore+n.HTscore),n.theta=(r.rectangleScore*r.theta+n.HTscore*((1-c)*n.theta+c*o))/(r.rectangleScore+n.HTscore),r.rectangleScore+=n.HTscore,n.width=f(n.width),n.height=f(n.height),n.theta=f(n.theta),n.x0=f(n.x0),n.y0=f(n.y0),u(n,t).then(function(a){a>B?(r.rect_width=n.width,r.rect_height=n.height,r.theta=n.theta,n.greyScore=a,r=i(r,n),s(n,"#FFA500",t),r.distances.push({distance2:f(Math.sqrt(Math.pow(n.x0-r.x_origin,2)+Math.pow(n.y0-r.y_origin,2))),distance:f(Math.abs(n.y0-r.y_origin)*Math.sqrt(r.m*r.m+1)),rectangle:n}),h(Math.floor(e.y+1.55*r.rect_height))):h(Math.floor(e.y+2))})}).catch(function(t){r.reject(new Error("Problem with finding grey bands"+t))}))},d=function(e,n,r,h){var i;return i=function(n){for(var a,s,c,l=!1;!l&&n<r.y_max;){for(a=Math.round(n*r.m+r.intercept),t.fillStyle("#BE5A52"),t.fillRect(Math.round(a+r.x_shift),Math.round(n+r.y_shift),1,1),s=0;1>s&&!l;s+=1)e[a+s]&&0===e[a+s][n].direction&&e[a+s][n].strength>0&&(o({x:a,y:n,end:!1},e,r,i),l=!0);n+=1}if(!l){for(c=0;c<r.distances.length;c+=1)r.distances[c].rectangle.width=r.rect_width,r.distances[c].rectangle.height=r.rect_height;r.resolve({rect_height:r.rect_height,rect_width:r.rect_width,bands:r.distances,indicatorBand:h})}},new Promise(function(t,e){r.resolve=t,r.reject=e,i(n)})},l=function(t,e,n){return function(r){var h,a;return h=0,a={x_shift:t.x_shift_left,y_shift:t.y_shift_down,x_center:e.x0,theta:e.theta,x_origin:e.x0,y_origin:e.y0,rect_width:e.width,rect_height:e.height,theta_origin:e.theta,y_max:r[0].length,x_max:r.length,rectangleScore:0,distances:[],greenRectangleScore:n,linearArr:[]},a=i(a,e),d(r,h,a,e)}},r=e.length,n=0;r>n;n+=1)H+=e[n].HTscore;return function(){var n,h;for(h=0;r>h;h+=1)w[h]=[],n=a(e[h]),j.push(t.getGaus(t.getGrey,n.x_shift_left-1,n.y_shift_down-1,n.width+2,n.height+2).then(c).then(l(n,e[h],H)))}(),Promise.all(j).then(function(e){var n,r,h,i,a,o,s=0,c=0,l=0,u=0,f=0,d=[];for(o=JSON.stringify(["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"]),r=0;r<e.length;r+=1)l+=(1+e[r].bands.length)*e[r].rect_height,u+=(1+e[r].bands.length)*e[r].rect_width,f+=1+e[r].bands.length;for(l/=f,u/=f,a=T/u+S/l,r=0;r<e.length;r+=1)for(n=(6.5-P)/a,h=0;h<e[r].bands.length;h+=1)e[r].bands[h].distance<n&&(i=Math.round(e[r].bands[h].distance*a+P),s+=e[r].bands[h].distance/i,c+=1);for(s/=c,a=R/u+G/l+A/s,r=0;r<e.length;r+=1){for(d[r]=JSON.parse(o),h=0;h<e[r].bands.length;h+=1)i=Math.round(e[r].bands[h].distance*a+I),e[r].bands[h].call=i,i>2&&(d[r][20>i-3?i-3:i-4]="1"),t.fillText(i,e[r].bands[h].rectangle.x0-u/2.2,e[r].bands[h].rectangle.y0-l/1.65,"Bold "+Math.round(1.5*l)+"px Georgia","#8A2BE2");hcvGenie.genotypesBase36.then(g(d[r],e[r]))}return{lanes:e,rect_width:u,rect_height:l,six_score:s}})},n=function(t){var e=2;return t.getLABcolorDist(0,0,t.width,t.height,_,e).then(function(n){var r,h,i=n.length,a=n[0].length,o=[[t.width,t.height],[0,0]];for(r=0;i>r;r+=1)for(h=0;a>h;h+=1)n[r][h]<p&&(o[0][0]=Math.min(r*e,o[0][0]),o[0][1]=Math.min(h*e,o[0][1]),o[1][0]=Math.max(r*e,o[1][0]),o[1][1]=Math.max(h*e,o[1][1]));return{xmin:o[0][0],ymin:o[0][1],width:o[1][0]-o[0][0]+1,height:o[1][1]-o[0][1]+1}})},e=function(t,e){var n=5;return t.getLABcolorDist(e.xmin-n,e.ymin-n,e.width+2*n,e.height+2*n,_,1).then(function(r){var h,i,a,c,u,g,d,x,w,b,P,S,T,I=r.length,G=r[0].length,R=[],A=JSON.parse(JSON.stringify(r)),B=[],H=[],j=[],D=[],E=3,O=0,k=0,N=0;for(d=function(t,e){return t.x0=t.x0+e.xmin-E,t.y0=t.y0+e.ymin-E,t.HTscore=f(t.HTscore/v),O+=t.HTscore*t.width,k+=t.HTscore*t.height,N+=t.HTscore,t},T=function(t){return y.submit({array:t,non_maximum_suppression:0,for_hough:!0,roundDigit:m,minimum_edge:v})},b=function(t){return function(e){return M.submit(e).then(function(e){return d(e,t)})}},h=0;I>h;h+=1)for(i=0;G>i;i+=1)A[h][i]<p&&(a=o(A,h,i),H.push(a.height),j.push(a.width),B.push(a));for(c=l(H),u=l(j),g=0;g<B.length;g+=1)B[g].width>u/2&&B[g].height>c/4&&R.push({height:B[g].height,width:B[g].width,x0:B[g].width/2+B[g].xmin+e.xmin-n,y0:B[g].height/2+B[g].ymin+e.ymin-n,xmin:B[g].xmin+e.xmin-n,ymin:B[g].ymin+e.ymin-n,theta:0});for(g=0;g<R.length;g+=1)x=Math.floor(R[g].xmin-E),w=Math.ceil(R[g].width+2*E),P=Math.floor(R[g].ymin-E),S=Math.ceil(R[g].height+2*E),D.push(t.getGaus(t.getLABcolorDist,x-1,P-1,w+2,S+2,_).then(T).then(b(R[g])));return Promise.all(D).then(function(e){for(g=0;g<e.length;g+=1)e[g].height=Math.round(k/N*m)/m,e[g].width=Math.round(O/N*m)/m,s(e[g],"#6666ff",t);return e})})},o=function(t,e,n){var r,h,i,a,o,s,c,l,u,f,g,d,M,y=2,m={ys:[n],xs:[e]},_={},x={};for(t[e][n]=2*p,_[n]=[e,e],x[e]=[n,n],r=0;r<m.ys.length;r+=1)if(o=m.ys[r],a=m.xs[r],f=_[o][0]===a?1:0,g=x[a][0]===o?1:0,d=_[o][1]===a?1:0,M=x[a][1]===o?1:0,f+g+d+M>0)for(c=a-y*f,u=a+y*d,s=o-y*g,l=o+y*M,h=c;u+1>h;h+=1)for(i=s;l+1>i;i+=1)h>0&&i>0&&h<t.length&&i<t[h].length&&t[h][i]<1.05*p&&(m.ys.push(i),m.xs.push(h),t[h][i]=3.5*p,x[h]=x[h]||[i,i],_[i]=_[i]||[h,h],x[h][0]=i<x[h][0]?i:x[h][0],x[h][1]=i>x[h][1]?i:x[h][1],_[i][0]=h<_[i][0]?h:_[i][0],_[i][1]=h>_[i][1]?h:_[i][1]);return{xmin:Math.min.apply(null,m.xs),ymin:Math.min.apply(null,m.ys),width:Math.max.apply(null,m.xs)-Math.min.apply(null,m.xs)+1,height:Math.max.apply(null,m.ys)-Math.min.apply(null,m.ys)+1}},u=function(t,e){var n,r,h=t.x0,i=t.y0,a=t.width,o=t.height;return n=Math.floor(h-a/2),r=Math.floor(i-o/2),o=Math.ceil(o),a=Math.ceil(a),e.getGrey(n,r,a,o,1).then(function(t){var e,n,r=[];for(e=0;e<t.length;e+=1)for(n=0;n<t[0].length;n+=1)r.push(t[e][n]);return l(r)})},i=function(t){var e,n,r={},h=t.getContext("2d"),i=h.getImageData(0,0,t.width,t.height).data,a={};return e=function(t){var e,r,h,i,a,o,s,c,l,u=[];for(h=t.length,i=t[0].length,e=2;h-2>e;e+=1)for(u.push([]),r=2;i-2>r;r+=1){for(l=0,o=0,s=-2;3>s;s+=1)for(c=-2;3>c;c+=1)t[e+s][r+c]&&(a=n(s,c),l+=a*t[e+s][r+c],o+=a);u[e-2].push(Math.round(m*l/o)/m)}return u},n=function(t,e){var n=Math.abs(e)+Math.abs(t);return 4===n?2:3===n?4:2!==n||0!==t&&0!==e?2===n?9:1===n?12:15:5},r.getRGB=function(e,n,r,h,a){var o,s,c,l=[],u=0;for(a=a||1,o=e;e+r>o;o+=a){for(l[u]=[],s=n;n+h>s;s+=a)c=4*(o+t.width*s),l[u].push([i[c],i[c+1],i[c+2]]);u+=1}return Promise.resolve(l)},r.getLABcolorDist=function(t,e,n,h,i,o){return o=o||1,new Promise(function(s,c){var l,u,f,g,M,y,_,p,v=[],b=[],P=x*o;if(p=i.join("-"),a.hasOwnProperty(p)||(a[p]={}),n*h/o/o>w){for(u=Math.ceil(n/P),f=Math.ceil(h/P),l=0;u*f>l;l+=1)y=t+l%u*P,_=e+Math.floor(l/u)*P,g=Math.min(P,n-y+t),M=Math.min(P,h-_+e),b.push([y-t,_-e]),v.push(r.getLABcolorDist(y,_,g,M,i,o));Promise.all(v).then(function(t){var e,n,r,h=[];for(e=0;e<t.length;e+=1)if(0===b[e][1])for(n=0;n<t[e].length;n+=1)h.push(t[e][n]);else for(n=0;n<t[e].length;n+=1)for(r=0;r<t[e][n].length;r+=1)h[n+b[e][0]/o].push(t[e][n][r]);s(h)}).catch(function(t){console.error(t),c(new Error("Error with getting RBG Quilted",t))})}else r.getRGB(t,e,n,h,o).then(function(r){var l,u,f;for(u=0;n>u;u+=o)for(f=0;h>f;f+=o)l=t+u*o+"_"+(e+f*o),a[p].hasOwnProperty(l)&&(r[u/o][f/o]=a[p][l]);d.submit({arr:r,col:i,roundDigit:m}).then(function(r){for(n=r.length,h=r[0].length,u=0;n>u;u+=1)for(f=0;h>f;f+=1)l=t+u*o+"_"+(e+f*o),a[p].hasOwnProperty(l)||(a[p][l]=r[u][f]);s(r)}).catch(function(t){c(new Error("Error with workers",t))})}).catch(function(t){c(new Error("Error with getting RBG",t))})})},r.getGaus=function(t,n,r,h,i,a){return t(n-2,r-2,h+4,i+4,a).then(e)},r.getGrey=function(t,e,n,h,i){return i=i||1,r.getRGB(t,e,n,h,i).then(function(t){var e,r,i;for(n=t.length,h=t[0].length,e=0;n>e;e+=1)for(r=0;h>r;r+=1)i=t[e][r],t[e][r]=f(.21*(1-i[0]/255)+.72*(1-i[1]/255)+.07*(1-i[2]/255));return t})},r.height=t.height,r.width=t.width,r.fillStyle=function(t){h.fillStyle=t},r.fillRect=function(t,e,n,r,i){i&&(h.fillStyle=i),h.fillRect(t,e,n,r)},r.fillRect=function(t,e,n,r,i){i&&(h.fillStyle=i),h.fillRect(t,e,n,r)},r.fillText=function(t,e,n,r,i){i&&(h.fillStyle=i),r&&(h.font=r),h.fillText(t,e,n)},r},c=function(t,e){return e>t?-1:t>e?1:0},r=function(t,e,n,r){return function(h){return h.getPage(t.image.pageNumber).then(function(t){var h,i,a;return i=r||2,h=t.getViewport(i),e.height=h.height,e.width=h.width,a={canvasContext:n,viewport:h},t.render(a).then(function(){return e})})}},h=function(r){var h,a,o;return h=i(r),a=n(h).then(function(t){return e(h,t)}),o=a.then(function(e){return t(h,e)}),{canvas:r,bandLocationPromise:o,canvasObject:h}},f=function(t){return Math.round(t*m)/m},a=function(t){return new Promise(function(e,n){var i,a,o,s;s=t.image.scale||2,i=document.createElement("canvas"),a=i.getContext("2d"),o="pdf"===t.image.type?PDFJS.getDocument(t.image.url).then(r(t,i,a,s)):new Promise(function(e,n){var r;r=new Image,r.onload=function(){i.width=r.width,i.height=r.height,a.drawImage(r,0,0,r.width,r.height),e(i)},r.onerror=function(t){n(new Error(t))},r.src=t.image.url}),o.then(h).then(function(t){t.error?n(new Error(t)):e(t)})})}}(),hcvGenie.genotypesBase36=function(){"use strict";return new Promise(function(t,e){var n=new XMLHttpRequest;n.overrideMimeType("application/json"),n.open("GET","./json/genotypesBase36.json",!0),n.onreadystatechange=function(){console.log(n.readyState,n.status,n),4===n.readyState&&200===n.status?t(JSON.parse(n.responseText)):4===n.readyState&&e(n.responseText+"Could not get database")},n.onerror=function(){e(n.responseText+"Could not get database")},n.send(null)})}();