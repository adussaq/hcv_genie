var hcvGenie={};hcvGenie.findBands=function(){"use strict";var t,e,n,r,i,h,a,o,s,c,l,u,f,g,d,y,M,m,w=1e4,_=[76.2806,-35.5237,23.7941],x=75,p=x*x*4,v=16,b=10,P=.025,S=.020734842905516,T=.1160010024291,I=1.255947650078826,H=.003233394220093,R=.009150503777635,A=.254982069800913,G=.822512153640132,j=.015;return d=amd_ww.startWorkers({filename:"./js/colorDistanceWorker.min.js",num_workers:4}),y=amd_ww.startWorkers({filename:"./js/houghTransformWorker.min.js",num_workers:2}),m=amd_ww.startWorkers({filename:"./js/vertHoughTransformWorker.min.js",num_workers:2}),M=amd_ww.startWorkers({filename:"./js/edgeDetectionWorker.min.js",num_workers:2}),l=function(t){var e;return e=JSON.parse(JSON.stringify(t)),e.sort(c),(e[Math.floor(e.length/2)]+e[Math.ceil(e.length/2)])/2},g=function(t){return function(e){return t.genotype=e,e}},s=function(t,e,n){var r,i,h,a,o,s,c,l,u=0,f=t.x0,g=t.y0,d=t.width,y=t.height,M=t.theta;for(i=Math.atan2(y,d),l=i+M,n.fillStyle(e),r=0;r<2*Math.PI;r+=u)a=Math.cos(r),o=Math.sin(r),r>l&&r<=Math.PI-l||r>Math.PI+l&&r<=2*Math.PI-l?(h=Math.abs(y/(2*o)),s=r<Math.PI?r:r-Math.PI,c=r<Math.PI?0:Math.PI,u=Math.abs(Math.acos(Math.cos(s+.3/h))+c-r)):(h=Math.abs(d/(2*a)),r<Math.PI/2?(s=r,c=0):r<Math.PI?(s=r-Math.PI/2,c=Math.PI/2):r<1.5*Math.PI?(s=r-Math.PI,c=Math.PI):(s=r-1.5*Math.PI,c=1.5*Math.PI),u=Math.abs(Math.asin(Math.sin(s+.3/h))+c-r)),n.fillRect(Math.floor(h*Math.cos(r)+f+.1),Math.floor(h*Math.sin(r)+g+.1),1,1),u=Math.max(u,Math.PI/180);n.fillRect(Math.round(f),Math.round(g)-1,1,3),n.fillRect(Math.round(f)-1,Math.round(g),3,1)},t=function(t,e){var n,r,i,h,a,o,c,l,d,_,x,p,v=2,b=[],B=Math.PI/180,D=1.65,k=0,O=[];for(p=function(t,e,n,r){var i;i=_(t,e,n,2),m.submit({array:i.array,roundDigit:w}).then(function(e){e.HTscore=f(e.HTscore/P/50),e.bool=!1,e.x0+=n.x_shift+i.x_shift,e.y0+=n.y_shift+i.y_shift,e.width=n.rect_width,e.height=n.rect_height,n.distances.push({distance2:f(Math.sqrt(Math.pow(e.x0-n.x_origin,2)+Math.pow(e.y0-n.y_origin,2))),distance:f(Math.abs(e.y0-n.y_origin)*Math.sqrt(n.m*n.m+1)),rectangle:e}),n=h(n,e),console.log("Done with course correction",e),r(t.y+1)}).catch(function(t){console.error(t)}),console.log("Performing a course correction",t,n,i)},h=function(t,e){var n,r,i,h,a,o,s=0,c=0,l=0,u=0,g=0;for(a=t.linearArr.length,n=0;n<e.HTscore/500+1;n+=1)t.linearArr.push([e.y0,e.x0]);for(r=t.linearArr.length,n=0;r>n;n+=1)g+=t.linearArr[n][1];for(g=f(g/r),n=0;r>n;n+=1)o=t.linearArr[n][1],o+=g-.5>o?.5:o>g+.5?-.5:0,s+=t.linearArr[n][0]*o,u+=t.linearArr[n][0],c+=o,l+=t.linearArr[n][0]*t.linearArr[n][0];return s/=r,c/=r,u/=r,l/=r,l!==u*u&&a?(i=(s-c*u)/(l-u*u),i=(i*t.distances.length+Math.tan(t.theta))/(t.distances.length+1)):i=Math.tan(e.theta),h=c-i*u+i*t.y_shift-t.x_shift,t.m=i,t.intercept=h,t},a=function(t){var e,n,r,h,a,o=t.theta,s=t.x0,c=t.y0,l=t.width,u=t.height;return a=Math.ceil(100*(27.5-S)/(I/l+T/u))/100,e=Math.floor(1.15*u+c),r=Math.ceil(a*Math.cos(Math.min(Math.abs(o),Math.abs(Math.abs(o)-B)))+2*v),i=20+Math.tan(B+Math.abs(o))*r,n=Math.floor(s-l/2-i),h=Math.ceil(l+2*i),{x_shift_left:n,y_shift_down:e,width:h,height:r}},_=function(t,e,n,r){var i,h,a,o,s,c,l;for(r=r||1,a=Math.ceil(n.rect_width*D),i=Math.floor(t.x-a/2),s=Math.ceil(Math.sin(Math.abs(n.theta))*a/2+n.rect_height*(D-1))*r,h=t.y-s,o=Math.ceil(n.rect_height+2*s),c=[],0>i&&(a+=2*i,i=0),0>h&&(o+=2*h,h=0),o+h>n.y_max-1&&(h=o+2*h-(n.y_max-1),o=n.y_max-1-h),a+i>n.x_max-1&&(i=a+2*i-(n.x_max-1),a=n.x_max-1-i),l=i;a+i>l;l+=1)c.push([]),c[c.length-1]=e[l].slice(h,o+h);return{array:c,x_shift:i,y_shift:h}},c=function(t){return M.submit({array:t,non_maximum_suppression:1,for_hough:!1,roundDigit:w,minimum_edge:P})},o=function(e,n,r,i){var a;e.end||(a=_(e,n,r),s({x0:a.array.length/2+r.x_shift+a.x_shift,y0:a.array[0].length/2+r.y_shift+a.y_shift,height:a.array[0].length,theta:0,width:a.array.length},"#FFFFCC",t),y.submit({array:a.array,roundDigit:w}).then(function(n){n.HTscore=f(n.HTscore/P/10),n.x0+=r.x_shift+a.x_shift,n.y0+=r.y_shift+a.y_shift,n.width=((r.greenRectangleScore+r.rectangleScore)*r.rect_width+n.width*n.HTscore)/(r.rectangleScore+r.greenRectangleScore+n.HTscore),n.height=((r.greenRectangleScore+r.rectangleScore)*r.rect_height+n.height*n.HTscore)/(r.rectangleScore+r.greenRectangleScore+n.HTscore),n.theta=(r.rectangleScore*r.theta+n.theta*n.HTscore)/(r.rectangleScore+n.HTscore),r.rectangleScore+=n.HTscore,n.width=f(n.width),n.height=f(n.height),n.theta=f(n.theta),n.x0=f(n.x0),n.y0=f(n.y0),u(n,t).then(function(a){a>j?(r.rect_width=n.width,r.rect_height=n.height,r.theta=n.theta,n.greyScore=a,r=h(r,n),s(n,"#FFA500",t),r.distances.push({distance2:f(Math.sqrt(Math.pow(n.x0-r.x_origin,2)+Math.pow(n.y0-r.y_origin,2))),distance:f(Math.abs(n.y0-r.y_origin)*Math.sqrt(r.m*r.m+1)),rectangle:n}),i(Math.floor(e.y+1.55*r.rect_height))):i(Math.floor(e.y+2))})}).catch(function(t){r.reject(new Error("Problem with finding grey bands"+t))}))},d=function(e,n,r,i){var h,a=.5;return h=function(n){for(var s,c,l,u=!1,f=0;!u&&n<r.y_max;){for(s=Math.round(n*r.m+r.intercept),t.fillStyle("#BE5A52"),t.fillRect(Math.round(s+r.x_shift),Math.round(n+r.y_shift),1,1),c=0;1>c&&!u;c+=1)e[s+c]&&0===e[s+c][n].direction&&e[s+c][n].strength>0&&(a=.5,o({x:s,y:n,end:!1},e,r,h),u=!0);f>a*r.rect_width&&r.distances.length<3&&(p({x:s,y:n,end:!1},e,r,h),a=1.5,u=!0),n+=1,f+=1}if(!u){for(l=0;l<r.distances.length;l+=1)r.distances[l].rectangle.width=r.rect_width,r.distances[l].rectangle.height=r.rect_height;r.resolve({rect_height:r.rect_height,rect_width:r.rect_width,bands:r.distances,indicatorBand:i})}},new Promise(function(t,e){r.resolve=t,r.reject=e,h(n)})},l=function(t,e,n){return function(r){var i,a;return i=0,a={x_shift:t.x_shift_left,y_shift:t.y_shift_down,x_center:e.x0,theta:e.theta,x_origin:e.x0,y_origin:e.y0,rect_width:e.width,rect_height:e.height,theta_origin:e.theta,y_max:r[0].length,x_max:r.length,rectangleScore:0,distances:[],greenRectangleScore:n,linearArr:[]},a=h(a,e),d(r,i,a,e)}},r=e.length,n=0;r>n;n+=1)k+=e[n].HTscore;return function(){var n,i;for(i=0;r>i;i+=1)b[i]=[],n=a(e[i]),O.push(t.getGaus(t.getGrey,n.x_shift_left-1,n.y_shift_down-1,n.width+2,n.height+2).then(c).then(l(n,e[i],k)))}(),x=Promise.all(O).then(function(e){var n,r,i,h,a,o=0,s=0,c=[],l=0,u=0,f=0;for(r=0;r<e.length;r+=1)l+=(1+e[r].bands.length)*e[r].rect_height,u+=(1+e[r].bands.length)*e[r].rect_width,f+=1+e[r].bands.length;for(l/=f,u/=f,a=I/u+T/l,console.log("before",JSON.parse(JSON.stringify(e))),r=0;r<e.length;r+=1)for(n=(6.5-S)/a,i=0;i<e[r].bands.length;i+=1)e[r].bands[i].rectangle.bool&&e[r].bands[i].distance<n?(h=Math.round(e[r].bands[i].distance*a+S),o+=e[r].bands[i].distance/h,s+=1):e[r].bands[i].rectangle.bool||(e[r].bands.splice(i,1),i-=1);for(console.log("after",JSON.parse(JSON.stringify(e))),o/=s,a=A/u+R/l+G/o,r=0;r<e.length;r+=1){for(c[r]=[],i=0;i<e[r].bands.length;i+=1)h=Math.round(e[r].bands[i].distance*a+H),e[r].bands[i].call=h,c[r].push(h),t.fillText(h,e[r].bands[i].rectangle.x0-u/2.2,e[r].bands[i].rectangle.y0-l/1.65,"Bold "+Math.round(1.5*l)+"px Georgia","#8A2BE2");hcvGenie.genotype(c[r]).then(g(e[r]))}return{lanes:e,rect_width:u,rect_height:l,six_score:o}})},n=function(t){var e=2;return t.getLABcolorDist(0,0,t.width,t.height,_,e).then(function(n){var r,i,h=n.length,a=n[0].length,o=[[t.width,t.height],[0,0]];for(r=0;h>r;r+=1)for(i=0;a>i;i+=1)n[r][i]<v&&(o[0][0]=Math.min(r*e,o[0][0]),o[0][1]=Math.min(i*e,o[0][1]),o[1][0]=Math.max(r*e,o[1][0]),o[1][1]=Math.max(i*e,o[1][1]));return{xmin:o[0][0],ymin:o[0][1],width:o[1][0]-o[0][0]+1,height:o[1][1]-o[0][1]+1}})},e=function(t,e){var n=5;return t.getLABcolorDist(e.xmin-n,e.ymin-n,e.width+2*n,e.height+2*n,_,1).then(function(r){var i,h,a,c,u,g,d,m,x,p,P,S,T,I=r.length,H=r[0].length,R=[],A=JSON.parse(JSON.stringify(r)),G=[],j=[],B=[],D=[],k=3,O=0,E=0,N=0;for(d=function(t,e){return t.x0=t.x0+e.xmin-k,t.y0=t.y0+e.ymin-k,t.HTscore=f(t.HTscore/b),O+=t.HTscore*t.width,E+=t.HTscore*t.height,N+=t.HTscore,t},T=function(t){return M.submit({array:t,non_maximum_suppression:0,for_hough:!0,roundDigit:w,minimum_edge:b})},p=function(t){return function(e){return y.submit(e).then(function(e){return d(e,t)})}},i=0;I>i;i+=1)for(h=0;H>h;h+=1)A[i][h]<v&&(a=o(A,i,h),j.push(a.height),B.push(a.width),G.push(a));for(c=l(j),u=l(B),g=0;g<G.length;g+=1)G[g].width>u/2&&G[g].height>c/4&&R.push({height:G[g].height,width:G[g].width,x0:G[g].width/2+G[g].xmin+e.xmin-n,y0:G[g].height/2+G[g].ymin+e.ymin-n,xmin:G[g].xmin+e.xmin-n,ymin:G[g].ymin+e.ymin-n,theta:0});for(g=0;g<R.length;g+=1)m=Math.floor(R[g].xmin-k),x=Math.ceil(R[g].width+2*k),P=Math.floor(R[g].ymin-k),S=Math.ceil(R[g].height+2*k),D.push(t.getGaus(t.getLABcolorDist,m-1,P-1,x+2,S+2,_).then(T).then(p(R[g])));return Promise.all(D).then(function(e){for(g=0;g<e.length;g+=1)e[g].height=Math.round(E/N*w)/w,e[g].width=Math.round(O/N*w)/w,s(e[g],"#6666ff",t);return console.log("greens!",e),e})})},o=function(t,e,n){var r,i,h,a,o,s,c,l,u,f,g,d,y,M=2,m={ys:[n],xs:[e]},w={},_={};for(t[e][n]=2*v,w[n]=[e,e],_[e]=[n,n],r=0;r<m.ys.length;r+=1)if(o=m.ys[r],a=m.xs[r],f=w[o][0]===a?1:0,g=_[a][0]===o?1:0,d=w[o][1]===a?1:0,y=_[a][1]===o?1:0,f+g+d+y>0)for(c=a-M*f,u=a+M*d,s=o-M*g,l=o+M*y,i=c;u+1>i;i+=1)for(h=s;l+1>h;h+=1)i>0&&h>0&&i<t.length&&h<t[i].length&&t[i][h]<1.05*v&&(m.ys.push(h),m.xs.push(i),t[i][h]=3.5*v,_[i]=_[i]||[h,h],w[h]=w[h]||[i,i],_[i][0]=h<_[i][0]?h:_[i][0],_[i][1]=h>_[i][1]?h:_[i][1],w[h][0]=i<w[h][0]?i:w[h][0],w[h][1]=i>w[h][1]?i:w[h][1]);return{xmin:Math.min.apply(null,m.xs),ymin:Math.min.apply(null,m.ys),width:Math.max.apply(null,m.xs)-Math.min.apply(null,m.xs)+1,height:Math.max.apply(null,m.ys)-Math.min.apply(null,m.ys)+1}},u=function(t,e){var n,r,i=t.x0,h=t.y0,a=t.width,o=t.height;return n=Math.floor(i-a/2),r=Math.floor(h-o/2),o=Math.ceil(o),a=Math.ceil(a),e.getGrey(n,r,a,o,1).then(function(t){var e,n,r=[];for(e=0;e<t.length;e+=1)for(n=0;n<t[0].length;n+=1)r.push(t[e][n]);return l(r)})},h=function(t){var e,n,r={},i=t.getContext("2d"),h=i.getImageData(0,0,t.width,t.height).data,a={};return e=function(t){var e,r,i,h,a,o,s,c,l,u=[];for(i=t.length,h=t[0].length,e=2;i-2>e;e+=1)for(u.push([]),r=2;h-2>r;r+=1){for(l=0,o=0,s=-2;3>s;s+=1)for(c=-2;3>c;c+=1)t[e+s][r+c]&&(a=n(s,c),l+=a*t[e+s][r+c],o+=a);u[e-2].push(Math.round(w*l/o)/w)}return u},n=function(t,e){var n=Math.abs(e)+Math.abs(t);return 4===n?2:3===n?4:2!==n||0!==t&&0!==e?2===n?9:1===n?12:15:5},r.getRGB=function(e,n,r,i,a){var o,s,c,l=[],u=0;for(a=a||1,o=e;e+r>o;o+=a){for(l[u]=[],s=n;n+i>s;s+=a)c=4*(o+t.width*s),l[u].push([h[c],h[c+1],h[c+2]]);u+=1}return Promise.resolve(l)},r.getLABcolorDist=function(t,e,n,i,h,o){return o=o||1,new Promise(function(s,c){var l,u,f,g,y,M,m,_,v=[],b=[],P=x*o;if(_=h.join("-"),a.hasOwnProperty(_)||(a[_]={}),n*i/o/o>p){for(u=Math.ceil(n/P),f=Math.ceil(i/P),l=0;u*f>l;l+=1)M=t+l%u*P,m=e+Math.floor(l/u)*P,g=Math.min(P,n-M+t),y=Math.min(P,i-m+e),b.push([M-t,m-e]),v.push(r.getLABcolorDist(M,m,g,y,h,o));Promise.all(v).then(function(t){var e,n,r,i=[];for(e=0;e<t.length;e+=1)if(0===b[e][1])for(n=0;n<t[e].length;n+=1)i.push(t[e][n]);else for(n=0;n<t[e].length;n+=1)for(r=0;r<t[e][n].length;r+=1)i[n+b[e][0]/o].push(t[e][n][r]);s(i)}).catch(function(t){console.error(t),c(new Error("Error with getting RBG Quilted",t))})}else r.getRGB(t,e,n,i,o).then(function(r){var l,u,f;for(u=0;n>u;u+=o)for(f=0;i>f;f+=o)l=t+u*o+"_"+(e+f*o),a[_].hasOwnProperty(l)&&(r[u/o][f/o]=a[_][l]);d.submit({arr:r,col:h,roundDigit:w}).then(function(r){for(n=r.length,i=r[0].length,u=0;n>u;u+=1)for(f=0;i>f;f+=1)l=t+u*o+"_"+(e+f*o),a[_].hasOwnProperty(l)||(a[_][l]=r[u][f]);s(r)}).catch(function(t){c(new Error("Error with workers",t))})}).catch(function(t){c(new Error("Error with getting RBG",t))})})},r.getGaus=function(t,n,r,i,h,a){return t(n-2,r-2,i+4,h+4,a).then(e)},r.getGrey=function(t,e,n,i,h){return h=h||1,r.getRGB(t,e,n,i,h).then(function(t){var e,r,h;for(n=t.length,i=t[0].length,e=0;n>e;e+=1)for(r=0;i>r;r+=1)h=t[e][r],t[e][r]=f(.21*(1-h[0]/255)+.72*(1-h[1]/255)+.07*(1-h[2]/255));return t})},r.height=t.height,r.width=t.width,r.fillStyle=function(t){i.fillStyle=t},r.fillRect=function(t,e,n,r,h){h&&(i.fillStyle=h),i.fillRect(t,e,n,r)},r.fillRect=function(t,e,n,r,h){h&&(i.fillStyle=h),i.fillRect(t,e,n,r)},r.fillText=function(t,e,n,r,h){h&&(i.fillStyle=h),r&&(i.font=r),i.fillText(t,e,n)},r},c=function(t,e){return e>t?-1:t>e?1:0},r=function(t,e,n,r){return function(i){return i.getPage(t.image.pageNumber).then(function(t){var i,h,a;return h=r||2,i=t.getViewport(h),e.height=i.height,e.width=i.width,a={canvasContext:n,viewport:i},t.render(a).then(function(){return e})})}},i=function(r){var i,a,o;return i=h(r),a=n(i).then(function(t){return e(i,t)}),o=a.then(function(e){return t(i,e)}),console.log("distanceMat?",o),{canvas:r,bandLocationPromise:o,canvasObject:i,canvasAnalysisRegion:o.region}},f=function(t){return Math.round(t*w)/w},a=function(t){return new Promise(function(e,n){var h,a,o,s;s=t.image.scale||2,h=document.createElement("canvas"),a=h.getContext("2d"),o="pdf"===t.image.type?PDFJS.getDocument(t.image.url).then(r(t,h,a,s)):new Promise(function(e,n){var r;r=new Image,r.onload=function(){h.width=r.width,h.height=r.height,a.drawImage(r,0,0,r.width,r.height),e(h)},r.onerror=function(t){n(new Error(t))},r.src=t.image.url}),o.then(i).then(function(t){t.error?n(new Error(t)):e(t)})})}}(),hcvGenie.genotype=function(){"use strict";var t=new Promise(function(t,e){var n=new XMLHttpRequest;n.overrideMimeType("application/json"),n.open("GET","./json/genotypesCurrent.json",!0),n.onreadystatechange=function(){console.log(n.readyState,n.status,n),4===n.readyState&&200===n.status?t(JSON.parse(n.responseText)):4===n.readyState&&e(n.responseText+"Could not get database")},n.onerror=function(){e(n.responseText+"Could not get database")},n.send(null)});return function(e){var n=["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"];return t.then(function(t){var r,i,h,a;for(r=0;r<e.length;r+=1)i=parseInt(e[r]),console.log(e[r],i),i&&!isNaN(i)&&i>2&&27>i&&(n[20>i-3?i-3:i-4]="1");return h=parseInt(n.join(""),2).toString(36),a=t.hasOwnProperty(h)?t[h].replace(/GNT/g,"Genotype"):"Unknown Band Pattern"})}}();