var hcvGenie={};hcvGenie.findBands=function(){"use strict";var t,e,n,r,h,i,a,o,s,c,l,u,f,g,d,m,y,M,w=1e4,_=[76.2806,-35.5237,23.7941],x=75,p=x*x*4,v=16,b=10,P=.025,S=.020734842905516,T=.1160010024291,I=1.255947650078826,H=.003233394220093,R=.009150503777635,A=.254982069800913,G=.822512153640132,k=.015;return d=amd_ww.startWorkers({filename:"./js/workers/colorDistanceWorker.min.js",num_workers:4}),m=amd_ww.startWorkers({filename:"./js/workers/houghTransformWorker.min.js",num_workers:2}),M=amd_ww.startWorkers({filename:"./js/workers/vertHoughTransformWorker.min.js",num_workers:2}),y=amd_ww.startWorkers({filename:"./js/workers/edgeDetectionWorker.min.js",num_workers:2}),l=function(t){var e;return e=JSON.parse(JSON.stringify(t)),e.sort(c),(e[Math.floor(e.length/2)]+e[Math.ceil(e.length/2)])/2},g=function(t){return function(e){return t.genotype=e,e}},s=function(t,e,n){var r,h,i,a,o,s,c,l,u=0,f=t.x0,g=t.y0,d=t.width,m=t.height,y=t.theta;for(h=Math.atan2(m,d),l=h+y,n.fillStyle(e),r=0;r<2*Math.PI;r+=u)a=Math.cos(r),o=Math.sin(r),r>l&&r<=Math.PI-l||r>Math.PI+l&&r<=2*Math.PI-l?(i=Math.abs(m/(2*o)),s=r<Math.PI?r:r-Math.PI,c=r<Math.PI?0:Math.PI,u=Math.abs(Math.acos(Math.cos(s+.3/i))+c-r)):(i=Math.abs(d/(2*a)),r<Math.PI/2?(s=r,c=0):r<Math.PI?(s=r-Math.PI/2,c=Math.PI/2):r<1.5*Math.PI?(s=r-Math.PI,c=Math.PI):(s=r-1.5*Math.PI,c=1.5*Math.PI),u=Math.abs(Math.asin(Math.sin(s+.3/i))+c-r)),n.fillRect(Math.floor(i*Math.cos(r)+f+.1),Math.floor(i*Math.sin(r)+g+.1),1,1),u=Math.max(u,Math.PI/180);n.fillRect(Math.round(f),Math.round(g)-1,1,3),n.fillRect(Math.round(f)-1,Math.round(g),3,1)},t=function(t,e){var n,r,h,i,a,o,c,l,d,_,x,p,v=2,b=[],j=Math.PI/180,B=1.65,D=0,E=[];for(p=function(t,e,n,r){var h;h=_(t,e,n,2),M.submit({array:h.array,roundDigit:w}).then(function(e){e.HTscore=f(e.HTscore/P/50),e.bool=!1,e.x0+=n.x_shift+h.x_shift,e.y0+=n.y_shift+h.y_shift,e.width=n.rect_width,e.height=n.rect_height,n.distances.push({distance2:f(Math.sqrt(Math.pow(e.x0-n.x_origin,2)+Math.pow(e.y0-n.y_origin,2))),distance:f(Math.abs(e.y0-n.y_origin)*Math.sqrt(n.m*n.m+1)),rectangle:e}),n=i(n,e),console.log("Done with course correction",e),r(t.y+1)}).catch(function(t){console.error(t)}),console.log("Performing a course correction",t,n,h)},i=function(t,e){var n,r,h,i,a,o,s=0,c=0,l=0,u=0,g=0;for(a=t.linearArr.length,n=0;n<e.HTscore/500+1;n+=1)t.linearArr.push([e.y0,e.x0]);for(r=t.linearArr.length,n=0;r>n;n+=1)g+=t.linearArr[n][1];for(g=f(g/r),n=0;r>n;n+=1)o=t.linearArr[n][1],o+=g-.5>o?.5:o>g+.5?-.5:0,s+=t.linearArr[n][0]*o,u+=t.linearArr[n][0],c+=o,l+=t.linearArr[n][0]*t.linearArr[n][0];return s/=r,c/=r,u/=r,l/=r,l!==u*u&&a?(h=(s-c*u)/(l-u*u),h=(h*t.distances.length+Math.tan(t.theta))/(t.distances.length+1)):h=Math.tan(e.theta),i=c-h*u+h*t.y_shift-t.x_shift,t.m=h,t.intercept=i,t},a=function(t){var e,n,r,i,a,o=t.theta,s=t.x0,c=t.y0,l=t.width,u=t.height;return a=Math.ceil(100*(27.5-S)/(I/l+T/u))/100,e=Math.floor(1.15*u+c),r=Math.ceil(a*Math.cos(Math.min(Math.abs(o),Math.abs(Math.abs(o)-j)))+2*v),h=20+Math.tan(j+Math.abs(o))*r,n=Math.floor(s-l/2-h),i=Math.ceil(l+2*h),{x_shift_left:n,y_shift_down:e,width:i,height:r}},_=function(t,e,n,r){var h,i,a,o,s,c,l;for(r=r||1,a=Math.ceil(n.rect_width*B),h=Math.floor(t.x-a/2),s=Math.ceil(Math.sin(Math.abs(n.theta))*a/2+n.rect_height*(B-1))*r,i=t.y-s,o=Math.ceil(n.rect_height+2*s),c=[],0>h&&(a+=2*h,h=0),0>i&&(o+=2*i,i=0),o+i>n.y_max-1&&(i=o+2*i-(n.y_max-1),o=n.y_max-1-i),a+h>n.x_max-1&&(h=a+2*h-(n.x_max-1),a=n.x_max-1-h),l=h;a+h>l;l+=1)c.push([]),c[c.length-1]=e[l].slice(i,o+i);return{array:c,x_shift:h,y_shift:i}},c=function(t){return y.submit({array:t,non_maximum_suppression:1,for_hough:!1,roundDigit:w,minimum_edge:P})},o=function(e,n,r,h){var a;e.end||(a=_(e,n,r),s({x0:a.array.length/2+r.x_shift+a.x_shift,y0:a.array[0].length/2+r.y_shift+a.y_shift,height:a.array[0].length,theta:0,width:a.array.length},"#FFFFCC",t),m.submit({array:a.array,roundDigit:w}).then(function(n){n.HTscore=f(n.HTscore/P/10),n.x0+=r.x_shift+a.x_shift,n.y0+=r.y_shift+a.y_shift,n.width=((r.greenRectangleScore+r.rectangleScore)*r.rect_width+n.width*n.HTscore)/(r.rectangleScore+r.greenRectangleScore+n.HTscore),n.height=((r.greenRectangleScore+r.rectangleScore)*r.rect_height+n.height*n.HTscore)/(r.rectangleScore+r.greenRectangleScore+n.HTscore),n.theta=(r.rectangleScore*r.theta+n.theta*n.HTscore)/(r.rectangleScore+n.HTscore),r.rectangleScore+=n.HTscore,n.width=f(n.width),n.height=f(n.height),n.theta=f(n.theta),n.x0=f(n.x0),n.y0=f(n.y0),u(n,t).then(function(a){a>k?(r.rect_width=n.width,r.rect_height=n.height,r.theta=n.theta,n.greyScore=a,r=i(r,n),s(n,"#FFA500",t),r.distances.push({distance2:f(Math.sqrt(Math.pow(n.x0-r.x_origin,2)+Math.pow(n.y0-r.y_origin,2))),distance:f(Math.abs(n.y0-r.y_origin)*Math.sqrt(r.m*r.m+1)),rectangle:n}),h(Math.floor(e.y+1.55*r.rect_height))):h(Math.floor(e.y+2))})}).catch(function(t){r.reject(new Error("Problem with finding grey bands"+t))}))},d=function(e,n,r,h){var i,a=.5;return i=function(n){for(var s,c,l,u=!1,f=0;!u&&n<r.y_max;){for(s=Math.round(n*r.m+r.intercept),t.fillStyle("#BE5A52"),t.fillRect(Math.round(s+r.x_shift),Math.round(n+r.y_shift),1,1),c=0;1>c&&!u;c+=1)e[s+c]&&0===e[s+c][n].direction&&e[s+c][n].strength>0&&(a=.5,o({x:s,y:n,end:!1},e,r,i),u=!0);f>a*r.rect_width&&r.distances.length<3&&(p({x:s,y:n,end:!1},e,r,i),a=1.5,u=!0),n+=1,f+=1}if(!u){for(l=0;l<r.distances.length;l+=1)r.distances[l].rectangle.width=r.rect_width,r.distances[l].rectangle.height=r.rect_height;r.resolve({rect_height:r.rect_height,rect_width:r.rect_width,bands:r.distances,indicatorBand:h})}},new Promise(function(t,e){r.resolve=t,r.reject=e,i(n)})},l=function(t,e,n){return function(r){var h,a;return h=0,a={x_shift:t.x_shift_left,y_shift:t.y_shift_down,x_center:e.x0,theta:e.theta,x_origin:e.x0,y_origin:e.y0,rect_width:e.width,rect_height:e.height,theta_origin:e.theta,y_max:r[0].length,x_max:r.length,rectangleScore:0,distances:[],greenRectangleScore:n,linearArr:[]},a=i(a,e),d(r,h,a,e)}},r=e.length,n=0;r>n;n+=1)D+=e[n].HTscore;return function(){var n,h;for(h=0;r>h;h+=1)b[h]=[],n=a(e[h]),E.push(t.getGaus(t.getGrey,n.x_shift_left-1,n.y_shift_down-1,n.width+2,n.height+2).then(c).then(l(n,e[h],D)))}(),x=Promise.all(E).then(function(e){var n,r,h,i,a,o=0,s=0,c=[],l=0,u=0,f=0;for(r=0;r<e.length;r+=1)l+=(1+e[r].bands.length)*e[r].rect_height,u+=(1+e[r].bands.length)*e[r].rect_width,f+=1+e[r].bands.length;for(l/=f,u/=f,a=I/u+T/l,r=0;r<e.length;r+=1)for(n=(6.5-S)/a,h=0;h<e[r].bands.length;h+=1)e[r].bands[h].rectangle.bool&&e[r].bands[h].distance<n?(i=Math.round(e[r].bands[h].distance*a+S),o+=e[r].bands[h].distance/i,s+=1):e[r].bands[h].rectangle.bool||(e[r].bands.splice(h,1),h-=1);for(o/=s,a=A/u+R/l+G/o,r=0;r<e.length;r+=1){for(c[r]=[],h=0;h<e[r].bands.length;h+=1)i=Math.round(e[r].bands[h].distance*a+H),e[r].bands[h].call=i,c[r].push(i),t.fillText(i,e[r].bands[h].rectangle.x0-u/2.2,e[r].bands[h].rectangle.y0-l/1.65,"Bold "+Math.round(1.5*l)+"px Georgia","#8A2BE2");hcvGenie.genotype(c[r]).then(g(e[r]))}return{lanes:e,rect_width:u,rect_height:l,six_score:o}})},n=function(t){var e=2;return t.getLABcolorDist(0,0,t.width,t.height,_,e).then(function(n){var r,h,i=n.length,a=n[0].length,o=[[t.width,t.height],[0,0]];for(r=0;i>r;r+=1)for(h=0;a>h;h+=1)n[r][h]<v&&(o[0][0]=Math.min(r*e,o[0][0]),o[0][1]=Math.min(h*e,o[0][1]),o[1][0]=Math.max(r*e,o[1][0]),o[1][1]=Math.max(h*e,o[1][1]));return{xmin:o[0][0],ymin:o[0][1],width:o[1][0]-o[0][0]+1,height:o[1][1]-o[0][1]+1}})},e=function(t,e){var n=5;return t.getLABcolorDist(e.xmin-n,e.ymin-n,e.width+2*n,e.height+2*n,_,1).then(function(r){var h,i,a,c,u,g,d,M,x,p,P,S,T,I=r.length,H=r[0].length,R=[],A=JSON.parse(JSON.stringify(r)),G=[],k=[],j=[],B=[],D=3,E=0,O=0,N=0;for(d=function(t,e){return t.x0=t.x0+e.xmin-D,t.y0=t.y0+e.ymin-D,t.HTscore=f(t.HTscore/b),E+=t.HTscore*t.width,O+=t.HTscore*t.height,N+=t.HTscore,t},T=function(t){return y.submit({array:t,non_maximum_suppression:0,for_hough:!0,roundDigit:w,minimum_edge:b})},p=function(t){return function(e){return m.submit(e).then(function(e){return d(e,t)})}},h=0;I>h;h+=1)for(i=0;H>i;i+=1)A[h][i]<v&&(a=o(A,h,i),k.push(a.height),j.push(a.width),G.push(a));for(c=l(k),u=l(j),g=0;g<G.length;g+=1)G[g].width>u/2&&G[g].height>c/4&&R.push({height:G[g].height,width:G[g].width,x0:G[g].width/2+G[g].xmin+e.xmin-n,y0:G[g].height/2+G[g].ymin+e.ymin-n,xmin:G[g].xmin+e.xmin-n,ymin:G[g].ymin+e.ymin-n,theta:0});for(g=0;g<R.length;g+=1)M=Math.floor(R[g].xmin-D),x=Math.ceil(R[g].width+2*D),P=Math.floor(R[g].ymin-D),S=Math.ceil(R[g].height+2*D),B.push(t.getGaus(t.getLABcolorDist,M-1,P-1,x+2,S+2,_).then(T).then(p(R[g])));return Promise.all(B).then(function(e){for(g=0;g<e.length;g+=1)e[g].height=Math.round(O/N*w)/w,e[g].width=Math.round(E/N*w)/w,s(e[g],"#6666ff",t);return e})})},o=function(t,e,n){var r,h,i,a,o,s,c,l,u,f,g,d,m,y=2,M={ys:[n],xs:[e]},w={},_={};for(t[e][n]=2*v,w[n]=[e,e],_[e]=[n,n],r=0;r<M.ys.length;r+=1)if(o=M.ys[r],a=M.xs[r],f=w[o][0]===a?1:0,g=_[a][0]===o?1:0,d=w[o][1]===a?1:0,m=_[a][1]===o?1:0,f+g+d+m>0)for(c=a-y*f,u=a+y*d,s=o-y*g,l=o+y*m,h=c;u+1>h;h+=1)for(i=s;l+1>i;i+=1)h>0&&i>0&&h<t.length&&i<t[h].length&&t[h][i]<1.05*v&&(M.ys.push(i),M.xs.push(h),t[h][i]=3.5*v,_[h]=_[h]||[i,i],w[i]=w[i]||[h,h],_[h][0]=i<_[h][0]?i:_[h][0],_[h][1]=i>_[h][1]?i:_[h][1],w[i][0]=h<w[i][0]?h:w[i][0],w[i][1]=h>w[i][1]?h:w[i][1]);return{xmin:Math.min.apply(null,M.xs),ymin:Math.min.apply(null,M.ys),width:Math.max.apply(null,M.xs)-Math.min.apply(null,M.xs)+1,height:Math.max.apply(null,M.ys)-Math.min.apply(null,M.ys)+1}},u=function(t,e){var n,r,h=t.x0,i=t.y0,a=t.width,o=t.height;return n=Math.floor(h-a/2),r=Math.floor(i-o/2),o=Math.ceil(o),a=Math.ceil(a),e.getGrey(n,r,a,o,1).then(function(t){var e,n,r=[];for(e=0;e<t.length;e+=1)for(n=0;n<t[0].length;n+=1)r.push(t[e][n]);return l(r)})},i=function(t){var e,n,r={},h=t.getContext("2d"),i=h.getImageData(0,0,t.width,t.height).data,a={};return e=function(t){var e,r,h,i,a,o,s,c,l,u=[];for(h=t.length,i=t[0].length,e=2;h-2>e;e+=1)for(u.push([]),r=2;i-2>r;r+=1){for(l=0,o=0,s=-2;3>s;s+=1)for(c=-2;3>c;c+=1)t[e+s][r+c]&&(a=n(s,c),l+=a*t[e+s][r+c],o+=a);u[e-2].push(Math.round(w*l/o)/w)}return u},n=function(t,e){var n=Math.abs(e)+Math.abs(t);return 4===n?2:3===n?4:2!==n||0!==t&&0!==e?2===n?9:1===n?12:15:5},r.getRGB=function(e,n,r,h,a){var o,s,c,l=[],u=0;for(a=a||1,o=e;e+r>o;o+=a){for(l[u]=[],s=n;n+h>s;s+=a)c=4*(o+t.width*s),l[u].push([i[c],i[c+1],i[c+2]]);u+=1}return Promise.resolve(l)},r.getLABcolorDist=function(t,e,n,h,i,o){return o=o||1,new Promise(function(s,c){var l,u,f,g,m,y,M,_,v=[],b=[],P=x*o;if(_=i.join("-"),a.hasOwnProperty(_)||(a[_]={}),n*h/o/o>p){for(u=Math.ceil(n/P),f=Math.ceil(h/P),l=0;u*f>l;l+=1)y=t+l%u*P,M=e+Math.floor(l/u)*P,g=Math.min(P,n-y+t),m=Math.min(P,h-M+e),b.push([y-t,M-e]),v.push(r.getLABcolorDist(y,M,g,m,i,o));Promise.all(v).then(function(t){var e,n,r,h=[];for(e=0;e<t.length;e+=1)if(0===b[e][1])for(n=0;n<t[e].length;n+=1)h.push(t[e][n]);else for(n=0;n<t[e].length;n+=1)for(r=0;r<t[e][n].length;r+=1)h[n+b[e][0]/o].push(t[e][n][r]);s(h)}).catch(function(t){console.error(t),c(new Error("Error with getting RBG Quilted",t))})}else r.getRGB(t,e,n,h,o).then(function(r){var l,u,f;for(u=0;n>u;u+=o)for(f=0;h>f;f+=o)l=t+u*o+"_"+(e+f*o),a[_].hasOwnProperty(l)&&(r[u/o][f/o]=a[_][l]);d.submit({arr:r,col:i,roundDigit:w}).then(function(r){for(n=r.length,h=r[0].length,u=0;n>u;u+=1)for(f=0;h>f;f+=1)l=t+u*o+"_"+(e+f*o),a[_].hasOwnProperty(l)||(a[_][l]=r[u][f]);s(r)}).catch(function(t){c(new Error("Error with workers",t))})}).catch(function(t){c(new Error("Error with getting RBG",t))})})},r.getGaus=function(t,n,r,h,i,a){return t(n-2,r-2,h+4,i+4,a).then(e)},r.getGrey=function(t,e,n,h,i){return i=i||1,r.getRGB(t,e,n,h,i).then(function(t){var e,r,i;for(n=t.length,h=t[0].length,e=0;n>e;e+=1)for(r=0;h>r;r+=1)i=t[e][r],t[e][r]=f(.21*(1-i[0]/255)+.72*(1-i[1]/255)+.07*(1-i[2]/255));return t})},r.height=t.height,r.width=t.width,r.fillStyle=function(t){h.fillStyle=t},r.fillRect=function(t,e,n,r,i){i&&(h.fillStyle=i),h.fillRect(t,e,n,r)},r.fillRect=function(t,e,n,r,i){i&&(h.fillStyle=i),h.fillRect(t,e,n,r)},r.fillText=function(t,e,n,r,i){i&&(h.fillStyle=i),r&&(h.font=r),h.fillText(t,e,n)},r},c=function(t,e){return e>t?-1:t>e?1:0},r=function(t,e,n,r){return function(h){return h.getPage(t.image.pageNumber).then(function(t){var h,i,a;return i=r||2,h=t.getViewport(i),e.height=h.height,e.width=h.width,a={canvasContext:n,viewport:h},t.render(a).then(function(){return e})})}},h=function(r){var h,a,o;return h=i(r),a=n(h).then(function(t){return e(h,t)}),o=a.then(function(e){return t(h,e)}),{canvas:r,bandLocationPromise:o,canvasObject:h,canvasAnalysisRegion:o.region}},f=function(t){return Math.round(t*w)/w},a=function(t){return new Promise(function(e,n){var i,a,o,s;s=t.image.scale||2,i=document.createElement("canvas"),a=i.getContext("2d"),o="pdf"===t.image.type?PDFJS.getDocument(t.image.url).then(r(t,i,a,s)):new Promise(function(e,n){var r;r=new Image,r.onload=function(){i.width=r.width,i.height=r.height,a.drawImage(r,0,0,r.width,r.height),e(i)},r.onerror=function(t){n(new Error(t))},r.src=t.image.url}),o.then(h).then(function(t){t.error?n(new Error(t)):e(t)})})}}(),hcvGenie.genotype=function(){"use strict";var t=new Promise(function(t,e){var n=new XMLHttpRequest;n.overrideMimeType("application/json"),n.open("GET","./json/genotypesCurrent.json",!0),n.onreadystatechange=function(){4===n.readyState&&200===n.status?t(JSON.parse(n.responseText)):4===n.readyState&&e(n.responseText+"Could not get database")},n.onerror=function(){e(n.responseText+"Could not get database")},n.send(null)});return function(e){var n=["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"];return t.then(function(t){var r,h,i,a;for(r=0;r<e.length;r+=1)h=parseInt(e[r]),h&&!isNaN(h)&&h>2&&27>h&&(n[20>h-3?h-3:h-4]="1");return i=parseInt(n.join(""),2).toString(36),a=t.hasOwnProperty(i)?t[i].replace(/GNT/g,"Genotype"):"Unknown Band Pattern"})}}();