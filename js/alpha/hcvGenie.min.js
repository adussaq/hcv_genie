var pix=[],myCanvas,glob,glob2,glob3,makeCanvas=function(t){var e={},a=t.getContext("2d"),r=a.getImageData(0,0,t.width,t.height).data,n={};return e.getRBG=function(e,a){return pos1=4*(e+t.width*a),[r[pos1],r[pos1+1],r[pos1+2]]},e.getLAB=function(t,e){return rgb2lab(myCanvas.getRBG(t,e))},e.getGreenDist=function(t,a){var r,h=[76.28056296,-35.52371953,23.79405389];if(n.hasOwnProperty(t+"_"+a))return n[t+"_"+a];col2=e.getLAB(t,a);var s=h[0],o=col2[0],i=h[1],g=col2[1],M=h[2],l=col2[2],c=(s+o)/2,d=Math.sqrt(Math.pow(i,2)+Math.pow(M,2)),f=Math.sqrt(Math.pow(g,2)+Math.pow(l,2)),u=(d+f)/2,y=Math.sqrt(Math.pow(u,7)/(Math.pow(u,7)+Math.pow(25,7))),v=(1-y)/2,G=i*(1+v),p=g*(1+v),P=Math.sqrt(Math.pow(G,2)+Math.pow(M,2)),m=Math.sqrt(Math.pow(p,2)+Math.pow(l,2)),I=(P+m)/2,w=Math.atan2(M,G)<0?Math.atan2(M,G)+2*Math.PI:Math.atan2(M,G),C=Math.atan2(l,p)<0?Math.atan2(l,p)+2*Math.PI:Math.atan2(l,p),x=P&&m?Math.abs(w-C)>Math.PI?(w+C)/2+Math.PI:(w+C)/2:0,D=1-.17*Math.cos(x-Math.PI/6)+.24*Math.cos(2*x)+.32*Math.cos(3*x+Math.PI/30)-.2*Math.cos(4*x-63*Math.PI/180),N=P&&m?C-w<-Math.PI/2?C-w+2*Math.PI:C-w>Math.PI/2?C-w-2*Math.PI:C-w:0,b=o-s,z=m-P,R=2*Math.sqrt(P*m)*Math.sin(N/2),S=Math.pow(c-50,2),B=1+.015*S/Math.sqrt(20+S),F=1+.045*I,q=1+.015*I*D,E=30*Math.exp(-1*Math.pow((180*x/Math.PI-275)/25,2)),k=2*y,J=-k*Math.sin(2*E);r=Math.sqrt(Math.pow(b/B,2)+Math.pow(z/F,2)+Math.pow(R/q,2)+J*(z/F)*(R/q));var O=1>r/16?r/16:2-16/r;return O=Math.round(1e3*O)/1e3,n[t+"_"+a]=O,O},e.getGreenDistGaus=function(t,a){return 1/115*(15*e.getGreenDist(t,a)+12*(e.getGreenDist(t-1,a)+e.getGreenDist(t+1,a)+e.getGreenDist(t,a-1)+e.getGreenDist(t,a+1))+9*(e.getGreenDist(t-1,a-1)+e.getGreenDist(t+1,a-1)+e.getGreenDist(t+1,a+1)+e.getGreenDist(t-1,a+1))+5*(e.getGreenDist(t,a-2)+e.getGreenDist(t,a+2)+e.getGreenDist(t+2,a)+e.getGreenDist(t-2,a))+4*(e.getGreenDist(t-1,a-2)+e.getGreenDist(t+1,a-2)+e.getGreenDist(t+1,a+2)+e.getGreenDist(t-1,a+2))+4*(e.getGreenDist(t-2,a-1)+e.getGreenDist(t+2,a-1)+e.getGreenDist(t+2,a+1)+e.getGreenDist(t-2,a+1))+2*(e.getGreenDist(t-2,a-2)+e.getGreenDist(t+2,a-2)+e.getGreenDist(t+2,a+2)+e.getGreenDist(t-2,a+2)))},e.getGrey=function(t,a){var r=e.getRBG(t,a);return 255*(.21*(1-r[0]/255)+.72*(1-r[1]/255)+.07*(1-r[2]/255))},e.getGreyGaus=function(t,a){return 1/115*(15*e.getGrey(t,a)+12*(e.getGrey(t-1,a)+e.getGrey(t+1,a)+e.getGrey(t,a-1)+e.getGrey(t,a+1))+9*(e.getGrey(t-1,a-1)+e.getGrey(t+1,a-1)+e.getGrey(t+1,a+1)+e.getGrey(t-1,a+1))+5*(e.getGrey(t,a-2)+e.getGrey(t,a+2)+e.getGrey(t+2,a)+e.getGrey(t-2,a))+4*(e.getGrey(t-1,a-2)+e.getGrey(t+1,a-2)+e.getGrey(t+1,a+2)+e.getGrey(t-1,a+2))+4*(e.getGrey(t-2,a-1)+e.getGrey(t+2,a-1)+e.getGrey(t+2,a+1)+e.getGrey(t-2,a+1))+2*(e.getGrey(t-2,a-2)+e.getGrey(t+2,a-2)+e.getGrey(t+2,a+2)+e.getGrey(t-2,a+2)))},e.height=t.height,e.width=t.width,e.fillStyle=function(t){a.fillStyle=t},e.fillRect=function(t,e,r,n){a.fillRect(t,e,r,n)},e},rgb2xyz=function(t){var e=t[0]/255,a=t[1]/255,r=t[2]/255;e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92,a=a>.04045?Math.pow((a+.055)/1.055,2.4):a/12.92,r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92;var n=.4124*e+.3576*a+.1805*r,h=.2126*e+.7152*a+.0722*r,s=.0193*e+.1192*a+.9505*r;return[100*n,100*h,100*s]},rgb2lab=function(t){var e,a,r,n=rgb2xyz(t),h=n[0],s=n[1],o=n[2];return h/=95.047,s/=100,o/=108.883,h=h>.008856?Math.pow(h,1/3):7.787*h+16/116,s=s>.008856?Math.pow(s,1/3):7.787*s+16/116,o=o>.008856?Math.pow(o,1/3):7.787*o+16/116,e=116*s-16,a=500*(h-s),r=200*(s-o),[e,a,r]},findGreen=function(t,e,a,r,n){var h,s,o=[[a,n],[e,r]];for(h=r;n>h;h+=2)for(s=e;a>s;s+=2)t.getGreenDist(s,h)<1&&(o[0][0]=Math.min(o[0][0],s),o[1][0]=Math.max(o[1][0],s),o[0][1]=Math.min(o[0][1],h),o[1][1]=Math.max(o[1][1],h));return o[0][0]-=5,o[0][1]-=5,o[1][0]+=5,o[1][1]+=5,o[0][0]=Math.max(o[0][0],e),o[0][1]=Math.max(o[0][1],r),o[1][0]=Math.min(o[1][0],a),o[1][1]=Math.min(o[1][1],n),o},findEdges=function(t,e,a,r,n,h,s){var o,i,g,M,l,c,d=[],f=[],u=[],y=67.5*Math.PI/180,v=22.5*Math.PI/180,G=[],p=[[0,0,0],[0,0,0],[0,0,0]];for(l=n;h>l;l+=1)for(d[l-n]=[],G[l-n]=[],f[l-n]=[],u[l-n]=[],c=a;r>c;c+=1)s&&console.log("EM array i, j",c,l),p[0][0]=t(c-1,l-1),p[1][0]=t(c-0,l-1),p[2][0]=t(c+1,l-1),p[0][1]=t(c-1,l+0),p[2][1]=t(c+1,l+0),p[0][2]=t(c-1,l+1),p[1][2]=t(c+0,l+1),p[2][2]=t(c+1,l+1),i=-1*p[0][0]+p[2][0]+-2*p[0][1]+2*p[2][1]+-1*p[2][0]+p[2][0],o=-1*p[0][0]-2*p[1][0]-p[2][0]+p[0][2]+2*p[1][2]+p[2][2],g=Math.sqrt(i*i+o*o),g=Math.round(1e3*g)/1e3,M=Math.atan(o/i),M=-y>M||M>y?0:M>-v&&v>M?90:M>v&&y>M?45:135,f[l-n][c-a]=M,d[l-n][c-a]=g,u[l-n][c-a]=Math.atan2(o,i);var P,m,I,w,C,x,D,N=1;for(l=n;h>l;l+=1)for(c=a;r>c;c+=1){switch(P=f[l-n][c-a],m=[],I=[],P){case 0:for(x=-N;N>=x;x+=1)w=c-a,C=l-n+x,w>=0&&w<d[0].length&&C>=0&&C<d.length&&f[C][w]===P&&(m.push(d[C][w]),I.push([C,w]));break;case 45:for(x=-N;N>=x;x+=1)w=c-a+x,C=l-n+x,w>=0&&w<d[0].length&&C>=0&&C<d.length&&f[C][w]===P&&(m.push(d[C][w]),I.push([C,w]));break;case 90:for(x=-N;N>=x;x+=1)w=c-a+x,C=l-n,w>=0&&w<d[0].length&&C>=0&&C<d.length&&f[C][w]===P&&(m.push(d[C][w]),I.push([C,w]));break;default:for(x=-N;N>=x;x+=1)w=c-a-x,C=l-n+x,w>=0&&w<d[0].length&&C>=0&&C<d.length&&f[C][w]===P&&(m.push(d[C][w]),I.push([C,w]))}for(D=Math.max.apply(null,m),x=0;x<I.length;x+=1)w=I[x][1],C=I[x][0],d[C][w]<D-.001?(d[C][w]=0,G[C][w]=0):G[C][w]=d[C][w]>e?[d[C][w],f[C][w]]:0}return G},findRectangles=function(t,e,a){var r,n,h,s,o=[],i=[],g=0,M=0,l=grabGreenMatrix(a),c=[],d=[];for(r=0;r<l.length;r+=1)for(n=0;n<l[r].length;n+=1)l[r][n]<1&&o.push(findPositiveNeighbors(l,r,n));for(n=0;n<o.length;n+=1)h=(Math.max.apply(null,o[n].xs)-Math.min.apply(null,o[n].xs))*(Math.max.apply(null,o[n].ys)-Math.min.apply(null,o[n].ys)),c.push(h),d.push(h);for(d=d.sort(function(t,e){return e>t?-1:t>e?1:0}),s=.5*(d[Math.floor(d.length/2)]+d[Math.ceil(d.length/2)]),console.log("areas",s,c,d),n=0;n<o.length;n+=1)c[n]>.25*s&&i.push(minimizeRectangle(o[n],e,a));for(n=0;n<i.length;n+=1)M+=i[n][2],g+=i[n][3];for(M/=i.length,g/=i.length,glob=JSON.parse(JSON.stringify(i)),n=0;n<i.length;n+=1)i[n][2]=M,i[n][3]=g,i[n][0]+=a[0][0],i[n][1]+=a[0][1],drawRectangle(i[n],"#52BE80");return glob2=JSON.parse(JSON.stringify(i)),console.log(i,a,l,o),i},minimizeRectangle=function(t,e,a){var r,n,h,s,o,t;return n=Math.max.apply(null,t.xs),h=Math.min.apply(null,t.xs),s=Math.max.apply(null,t.ys),o=Math.min.apply(null,t.ys),r=[h-2,o-2,n+2,s+2,(n-h)/2+h,(s-o)/2+o],t=houghTrans(t,e,r,!1,a[0][0],a[0][1])},findPositiveNeighbors=function(t,e,a){var r,n,h,s,o,i,g,M,l,c,d,f,u,v=2,G={ys:[e],xs:[a]},p={},P={};for(t[e][a]=10,p[e]=[a,a],P[a]=[e,e],n=0;n<G.ys.length;n+=1)for(y=G.ys[n],x=G.xs[n],c=p[y][0]===x?1:0,d=P[x][0]===y?1:0,f=p[y][1]===x?1:0,u=P[x][1]===y?1:0,r=v;r>0&&c+d+f+u;){for(g=x-r*c,l=x+r*f,i=y-r*d,M=y+r*u,s=i;M+1>s;s+=1)for(o=s===y-r||s===y+r?1:g===x||l===x?r:2*r,h=g;l+1>h;h+=o)s>0&&h>0&&s<t.length&&h<t[s].length&&t[s][h]<1&&(G.ys.push(s),G.xs.push(h),t[s][h]=10,P[h]=P[h]||[s,s],p[s]=p[s]||[h,h],P[h][0]=s<P[h][0]?s:P[h][0],P[h][1]=s>P[h][1]?s:P[h][1],p[s][0]=h<p[s][0]?h:p[s][0],p[s][1]=h>p[s][1]?h:p[s][1]);r-=1}return G},houghTrans=function(t,e,a,r,n,h){var s,o,i,g,M,l,c,d,f,u,y,v,G;i=a[4],g=a[5],y={rho:[],theta:[]},u={vert:{distPos:[0,0,0],distNeg:[0,0,0]},horz:{distPos:[0,0,0],distNeg:[0,0,0]}},G={},n=n||0,h=h||0,f=Math.sqrt(Math.pow(a[3]-a[1],2)+Math.pow(a[2]-a[0],2))/2,bins=Math.ceil(8*f/3),radBins=Math.ceil(10*Math.PI*f/4),v=function(t,e,a,r){e>=0&&(u[r].distPos[0]+=t*a,u[r].distPos[1]+=e*a,u[r].distPos[2]+=a),0>=e&&(u[r].distNeg[0]+=t*a,u[r].distNeg[1]+=e*a,u[r].distNeg[2]+=a)};var M=[];for(o=a[1];o<=a[3];o+=1)for(s=a[0];s<=a[2];s+=1)if(e[o]&&e[o][s]){if(M.push([]),l=M.length-1,0===e[o][s][1]||45===e[o][s][1]||135===e[o][s][1])for(c=5*Math.PI/12;c<7*Math.PI/12;c+=5*Math.PI/6/radBins)d=(s-i)*Math.cos(c)+(o-g)*Math.sin(c),M[l].push([c,d]),v(c,d,e[o][s][0],"horz");if(90===e[o][s][1]||45===e[o][s][1]||135===e[o][s][1])for(c=-Math.PI/12;c<Math.PI/12;c+=5*Math.PI/6/radBins)d=(s-i)*Math.cos(c)+(o-g)*Math.sin(c),M[l].push([c,d]),v(c,d,e[o][s][0],"vert")}glob2=u;var p=(u.vert.distPos[0]+u.vert.distNeg[0]-Math.PI/2*(u.horz.distPos[2]+u.horz.distNeg[2])+u.horz.distPos[0]+u.horz.distNeg[0])/(u.vert.distPos[2]+u.vert.distNeg[2]+u.horz.distPos[2]+u.horz.distNeg[2]),P=g+u.horz.distPos[1]/u.horz.distPos[2]+u.horz.distNeg[1]/u.horz.distNeg[2],m=i+u.vert.distPos[1]/u.vert.distPos[2]+u.vert.distNeg[1]/u.vert.distNeg[2],I=u.horz.distPos[1]/u.horz.distPos[2]-u.horz.distNeg[1]/u.horz.distNeg[2],w=u.vert.distPos[1]/u.vert.distPos[2]-u.vert.distNeg[1]/u.vert.distNeg[2];return u.vert.distPos[0]/=u.vert.distPos[2]/180*Math.PI,u.vert.distPos[1]/=u.vert.distPos[2],u.vert.distNeg[0]/=u.vert.distNeg[2]/180*Math.PI,u.vert.distNeg[1]/=u.vert.distNeg[2],u.horz.distPos[0]/=u.horz.distPos[2]/180*Math.PI,u.horz.distPos[1]/=u.horz.distPos[2],u.horz.distNeg[0]/=u.horz.distNeg[2]/180*Math.PI,u.horz.distNeg[1]/=u.horz.distNeg[2],r&&console.log("\nparameters",a,"\ndenDiffX",Math.abs(u.vert.distPos[2]-u.vert.distNeg[2]),"\ndenDiffY",Math.abs(u.horz.distPos[2]-u.horz.distNeg[2])),drawRectangle([i+n,g+h,a[2]-a[0],a[3]-a[1],0],"#FF3300"),[m,P,w,I,p]},grabGreenMatrix=function(t){var e,a,r=[];for(a=t[0][1];a<t[1][1];a+=1)for(r.push([]),e=t[0][0];e<t[1][0];e+=1)r[r.length-1].push(myCanvas.getGreenDist(e,a));return r},drawRectangle=function(t,e){var a,r,n,h,s,o,i,g=0,M=t[0],l=t[1],c=t[2],d=t[3],f=t[4];for(r=Math.atan2(d,c),thetaS=r+f,myCanvas.fillStyle(e),a=0;a<2*Math.PI;a+=g)h=Math.cos(a),s=Math.sin(a),a>thetaS&&a<=Math.PI-thetaS||a>Math.PI+thetaS&&a<=2*Math.PI-thetaS?(n=Math.abs(d/(2*s)),o=a<Math.PI?a:a-Math.PI,i=a<Math.PI?0:Math.PI,g=Math.abs(Math.acos(Math.cos(o+.3/n))+i-a)):(n=Math.abs(c/(2*h)),a<Math.PI/2?(o=a,i=0):a<Math.PI?(o=a-Math.PI/2,i=Math.PI/2):a<1.5*Math.PI?(o=a-Math.PI,i=Math.PI):(o=a-1.5*Math.PI,i=1.5*Math.PI),g=Math.abs(Math.asin(Math.sin(o+.3/n))+i-a)),myCanvas.fillRect(Math.floor(n*Math.cos(a)+M+.1),Math.floor(n*Math.sin(a)+l+.1),1,1);myCanvas.fillRect(Math.round(M),Math.round(l)-1,1,3),myCanvas.fillRect(Math.round(M)-1,Math.round(l),3,1)},findBandLocations=function(t){var e,a,r,n,h,s,o,i,g,M,l,c,d,f,u,y,v,G,p,P=0,m=!1,I=[];for(e=0;e<t.length;e+=1){for(console.log("Testing lane "+(e+1)+"."),g=1,I[e]=[],h=t[e][4],s=t[e][0],o=t[e][1],i=t[e][2],n=t[e][3],G=Math.ceil(17.01*i*100)/100,c=Math.floor(n+o),P=Math.ceil(G*Math.cos(Math.min(Math.abs(h),Math.abs(Math.abs(h)-Math.PI/180)))+o+2),y=Math.sin(Math.PI/180+Math.abs(h))*G,l=Math.ceil(s+i/2+y)+2,d=Math.ceil(s-i/2-y)-2,l=Math.min(l,myCanvas.width),d=Math.max(d,0),r=findEdges(myCanvas.getGreyGaus,5,d,l,c,P,!1),console.log(i,n,d,l,c,P),a=1;a<r.length;a+=1)if(f=Math.round((a+c-o)*Math.tan(h)+(s-d)),u=a,myCanvas.fillStyle("#BE5A52"),myCanvas.fillRect(Math.round(f+d),Math.round(u+c),1,1),r[u][f]&&0===r[u][f][1]&&r[u][f][0]>25){u=a+.5*n,f=u*Math.tan(h)+(s-d),rect=houghTrans([],r,[Math.max(Math.floor(f-.7*i),0),Math.max(Math.floor(a-.25*n),0),Math.min(Math.ceil(f+.7*i),l-d),Math.min(Math.ceil(a+1.5*n),r.length),f,u],!1,d,c),rect[0]+=d,rect[1]+=c,rect[2]=(i*(4+g+t.length)+rect[2])/(5+g+t.length),rect[3]=(n*(4+g+t.length)+rect[3])/(5+g+t.length);var w=Math.atan2(rect[0]-s,rect[1]-o);rect[4]=g*h/(g+1)+(4*rect[4]+w)/(g+1)/5,0>h*w&&(rect[4]/=2),isGrey(rect,m)&&(i=rect[2],n=rect[3],h=rect[4],s=(g*rect[0]+s)/(g+1),drawRectangle(rect,"#4DCBCA"),v=Math.sqrt(.95*Math.pow(t[e][0]-rect[0],2)+1.05*Math.pow(o-rect[1],2)),I[e].push(v),a+=Math.ceil(1.5*n),g+=1)}for(M=.634,a=0;a<I[e].length;a+=1)p=Math.round(I[e][a]/i/M*10)/10,p>26.5?(I[e].splice(a,1),a-=1):I[e][a]=p}return console.log(I),glob3=I,I},isGrey=function(t,e){var a,r,n,h,s,o,i,g,M,l=t[0],c=t[1],d=t[2],f=t[3],u=t[4],y=[];for(a=Math.atan2(f,d),thetaS=a+u,r=Math.sqrt(d*d+f*f)/2,s=Math.ceil(r*Math.cos(Math.PI+thetaS)+l),o=Math.ceil(r*Math.sin(Math.PI+thetaS)+c),i=Math.floor(r*Math.cos(thetaS)+l),g=Math.floor(r*Math.sin(thetaS)+c),e&&(myCanvas.fillStyle("#FFCCFF"),myCanvas.fillRect(s,o-1,1,3),myCanvas.fillRect(s-1,o,3,1),myCanvas.fillStyle("#CCFFCC"),myCanvas.fillRect(i,g-1,1,3),myCanvas.fillRect(i-1,g,3,1)),M=0,n=s;i>=n;n+=1)for(h=o;g>=h;h+=1)y.push(myCanvas.getGrey(n,h));return y=y.sort(function(t,e){return e>t?-1:t>e?1:0}),M=y[Math.floor(y.length/2)]/2+y[Math.ceil(y.length/2)]/2,e&&console.log("median grey",M),5>M?!1:!0},processCanvas=function(t){myCanvas=makeCanvas(t);var e=0,a=0,r=myCanvas.height,n=myCanvas.width;console.log("Finding Green"),myGreen=findGreen(myCanvas,a,n,e,r),console.log("Finding Green Edges"),myGreenEdges=findEdges(myCanvas.getGreenDistGaus,1.5,myGreen[0][0],myGreen[1][0],myGreen[0][1],myGreen[1][1]),console.log("Finding Green Rectangles"),rects=findRectangles(myGreen,myGreenEdges,myGreen),rects=rects.sort(function(t,e){return t[0]<e[0]?-1:e[0]<t[0]?1:0}),console.log("finding experiments");var h=findBandLocations(rects);return h},convertPDF2Canvas=function(t){return function(e){return e.getPage(t.image.pageNumber).then(function(e){var a,r,n,h,s=2;return a=e.getViewport(s),r=document.getElementById(t.canvas),n=r.getContext("2d"),r.height=a.height,r.width=a.width,h={canvasContext:n,viewport:a},e.render(h).then(function(){return r})})}},hcvGenie={};hcvGenie.findBands=function(t){var e,a,r;if(e=document.getElementById(t.canvas),a=e.getContext("2d"),"pdf"===t.image.type)return PDFJS.getDocument(t.image.url).then(convertPDF2Canvas(t)).then(processCanvas);new Promise(function(n){r=new Image,r.onload=function(){e.width=r.width,e.height=r.height,a.drawImage(r,0,0,r.width,r.height),n(processCanvas(e))},r.src=t.image.url})};