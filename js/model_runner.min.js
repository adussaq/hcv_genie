!function(){"use strict";var e,n,t,a,o,i,r,s,c,l,d=[],u=jQuery,m=!1;window.onload=function(){var e;window.scrollTo(0,0),window.location.hash&&u('a[href="'+window.location.hash+'"]').click(),e=window.location.search&&window.location.search.match(/[?&]params=[^&?#]+/)?window.location.search.match(/([?&]params=)([^&?#]+)/)[2]:"./json/default_params.json",u.get(e,function(e){n=e}).fail(function(){u("#home").children().hide(),u("#home").append('<div class="container well">Failed to load constants object, this tool does not work without that. Please provide it in the url using a data= tag, or remove the data= tag to utilize the defaults.</div>'),alert("Failed to get constants object, make sure your '?params=...' URL is correct and CORS enabled.")})},a=function(e){if(window.File&&window.FileReader&&window.FileList&&window.Blob){var n,a=new FileReader;a.onload=function(a){n=a.target.result,t(e,n,2)},a.readAsDataURL(e)}else window.alert("The File APIs are not fully supported in this browser.")},t=function(e,t,a){console.log("starting scale:"+a),r.empty(),r.height(""),e.name.match(/\.pdf$/)?hcvGenie.findBands({image:{type:"pdf",pageNumber:1,url:t,scale:a,parameters:n}}).then(o(e,t,a)):hcvGenie.findBands({image:{type:"png",url:t,parameters:n}}).then(o(e,t,a))},s=function(e,n,a,o){d.push(e),o+.249<2.5?(t(n,a,o+.249),r.empty(),r.height(""),u("#model").empty(),u("#download_params").addClass("hidden")):(m=!1,l.toggleClass("disabled"),c.show(),u("#download_params").removeClass("hidden"))},o=function(e,n,t){return function(a){a.bandingPromise.then(function(o){o.lanePromise.then(function(e){i({canvas:u(a.canvasObject.canvasHolder),all:!1,region:e.region})}),u("#model").append(u("<div>",{class:"col-xs-12 col-sm-4 col-sm-offset-4 col",style:"margin-top:15px"}).append(u("<button>",{text:"Done editing",class:"btn btn-lg btn-primary text-center center-block bottom-buffer"}).click(function(a){a.preventDefault(),u("#model").empty(),o.model_fit_data().then(function(a){s(a,e,n,t)})})).append("<p>Correct any errors before continuing. This will run 3 times on each image at different zoom levels, then it will generate an object for you to download. Or you will be able to add another image to create a more stable soultion.</p>"))}),r.append(a.canvasObject.canvasHolder),a.canvasObject.canvasHolder.height(a.canvasObject.canvasHolder.children().height())}},i=function(e){var n;n=e.all?function(){r.empty(),r.css("overflow",""),r.css("height",""),r.append(e.canvas.width(r.width()))}:function(){var n,t,a,o,i,s;n=r.width(),a=Math.min(e.region.min[0],e.region.width-e.region.max[0]),o=e.region.width-2*a,t=n/o,i=-1*e.region.min[1]*t,s=(e.region.max[1]-e.region.min[1])*t,r.css("overflow","hidden"),r.css("position","relative"),r.css("height",s),r.attr("class","my-img-thumbnail"),r.append(e.canvas.width(n+2*a*t)),e.canvas.css("margin-top",i),e.canvas.css("margin-left",-a*t)},n(),u(window).unbind("resize"),u(window).resize(n)},function(){var n,t,o=!1;t=u(".computerFile"),l=u(".computerFileButton"),c=u("#drop_model"),r=u("#model_img"),n=document.createElement("span"),(void 0===n.draggable||void 0===n.ondragleave&&void 0===n.ondragover&&void 0===n.ondrop)&&c.parent().empty(),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera\ Mini/i.test(navigator.userAgent)&&c.parent().empty(),t.change(function(e){m?e.preventDefault():(m=!0,c.hide(),a(e.target.files[0]),l.toggleClass("disabled"))}),c.on("dragover",function(e){return e.preventDefault(),e.stopPropagation(),o||m||(c.addClass("hover"),o=!0),!1}),c.on("dragleave",function(e){return e.preventDefault(),e.stopPropagation(),c.removeClass("hover"),o=!1,!1}),c.on("drop",function(e){e.preventDefault(),e.stopPropagation(),c.removeClass("hover"),o=!1,m||(l.toggleClass("disabled"),m=!0,c.hide(),a(e.originalEvent.dataTransfer.files[0]))}),u("#download_params").click(function(n){var t,a,o,i,r,s,c,l,u,m;n.preventDefault(),setTimeout(function(){m={grey:{},distance:{},distance2:{}},t=new Date,t=t.toLocaleDateString().replace(/\//g,"_")+"_"+t.getHours().toString()+"_"+t.getMinutes().toString(),c=d.map(function(e){return e.grey_scores.data}).reduce(function(e,n){return e.concat(n)}),l=LINEARFIT(c.map(function(e){return e.slice(1,e.length)}),c.map(function(e){return e[0]}),1),l.params.map(function(e,n){var t=d[0].grey_scores.columns[n+1]||"constant";m.grey[t]=e}),u=-1/0,c.map(function(e){var n,t=l.params[e.length-1];for(n=1;n<e.length;n+=1)t+=l.params[n-1]*e[n];e[0]||(u=Math.max(u,t))}),m.grey.minimum=u,a=d.map(function(e){return e.distances.data}).reduce(function(e,n){return e.concat(n)}),o=[],i=[],a.map(function(e){e[0]<7?o.push(e):i.push(e)}),r=LINEARFIT(o.map(function(e){return e.slice(1,e.length-1)}),o.map(function(e){return e[0]}),1),s=LINEARFIT(i.map(function(e){return e.slice(1,e.length)}),i.map(function(e){return e[0]}),1),r.params.map(function(e,n){var t=d[0].distances.columns[n+1];t="dist_sixScore"===t?"constant":t,t=t.replace("dist_",""),m.distance[t]=e}),s.params.map(function(e,n){var t=d[0].distances.columns[n+1]||"constant";t=t.replace("dist_",""),m.distance2[t]=e}),e(JSON.stringify(m),"hcvgenie_params_"+t+".json")},1e3)})}(),e=function(){var e=document.createElement("a");return document.body.appendChild(e),function(n,t){var a=new Blob([n],{type:"octet/stream"}),o=window.URL.createObjectURL(a);e.href=o,e.download=t,e.click(),window.URL.revokeObjectURL(o)}}()}();