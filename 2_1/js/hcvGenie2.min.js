var hcvGenie={},medianSignals=[],acceptedMedians=[],posDistances=[],failedRects=[];hcvGenie.findBands=function(){"use strict";var t,e,n,r,a,i,h,o,c,s,l,u,d,g,f,m,_,p,y,v,M,x,b,w,T,H,S=[76.2806,-35.5237,23.7941],z={grey:{avg:1.6610618397421548,median:.38757400854705043,horz:-.000991798099228899,vert:-58297930746602716e-21,avg_horz:.018609796526077926,avg_vert:.007040155327921288,med_horz:0,med_vert:0,constant:-.2071098879225205,minimum:.20642615662898506},distance:{height:.11794033910745608,width:1.2547484108366547,constant:.01295329735651057},distance2:{height:.0464379552605775,width:-.013883466855960229,sixScore:.9142819178400069,constant:.01260090260756326}};return b=amd_ww.startWorkers({filename:"../js/workers/colorDistanceWorker.min.js",num_workers:4}),w=amd_ww.startWorkers({filename:"../js/workers/houghTransformWorker.min.js",num_workers:2}),H=amd_ww.startWorkers({filename:"../js/workers/vertHoughTransformWorker.min.js",num_workers:2}),T=amd_ww.startWorkers({filename:"../js/workers/edgeDetectionWorker.min.js",num_workers:2}),l=function(t){var e;return e=JSON.parse(JSON.stringify(t)),e=e.sort(s),(e[Math.floor((e.length-1)/2)]+e[Math.ceil((e.length-1)/2)])/2},p=function(t,e){return function(){var n;for(n=0;n<t.length;n+=1)e.clearRect(t[n][0],t[n][1],t[n][2],t[n][3])}},g=function(t){return function(e){return t.genotype=e,e}},c=function(t,e,n){var r,a,i,h,o,c,s,l,u,d,g=0,f=t.x0,m=t.y0,_=t.width,y=t.height,v=t.theta,M=[];for(a=Math.atan2(y,_),l=a+v,n.fillStyle(e),r=0;r<2*Math.PI;r+=g)h=Math.cos(r),o=Math.sin(r),r>l&&r<=Math.PI-l||r>Math.PI+l&&r<=2*Math.PI-l?(i=Math.abs(y/(2*o)),c=r<Math.PI?r:r-Math.PI,s=r<Math.PI?0:Math.PI,g=Math.abs(Math.acos(Math.cos(c+.3/i))+s-r)):(i=Math.abs(_/(2*h)),r<Math.PI/2?(c=r,s=0):r<Math.PI?(c=r-Math.PI/2,s=Math.PI/2):r<1.5*Math.PI?(c=r-Math.PI,s=Math.PI):(c=r-1.5*Math.PI,s=1.5*Math.PI),g=Math.abs(Math.asin(Math.sin(c+.3/i))+s-r)),u=Math.floor(i*Math.cos(r)+f+.1),d=Math.floor(i*Math.sin(r)+m+.1),M.push([u,d,1,1]),n.fillRect(u,d,1,1),g=Math.max(g,Math.PI/180);return M.push([Math.round(f),Math.round(m)-1,1,3]),M.push([Math.round(f)-1,Math.round(m),3,1]),n.fillRect(Math.round(f),Math.round(m)-1,1,3),n.fillRect(Math.round(f)-1,Math.round(m),3,1),p(M,n)},x=function(t){var e=!1;return t.theta&&t.height&&t.width&&t.x0&&t.y0&&Math.abs(t.theta)+Math.abs(t.height)+Math.abs(t.width)+Math.abs(t.x0)+Math.abs(t.y0)<1/0&&(e=!0),e},t=function(t,e){var n,r,a,i,h,o,s,l,f,p,v,b,S=[],k=Math.PI/180,P=0,G=[],R={min:[t.width,t.height],max:[0,0],width:t.width,height:t.height};for(b=function(t,e,n,r){var a;a=p(t,e,n,2),H.submit({array:a.array,roundDigit:1e4}).then(function(e){e.bool&&x(e)?(e.HTscore=d(e.HTscore/.05/50),e.bool=!1,e.x0+=n.x_shift+a.x_shift,e.y0+=n.y_shift+a.y_shift,e.width=n.rect_width,e.height=n.rect_height,n.distances.push({distance2:d(Math.sqrt(Math.pow(e.x0-n.x_origin,2)+Math.pow(e.y0-n.y_origin,2))),distance:d(Math.abs(e.y0-n.y_origin)*Math.sqrt(n.m*n.m+1)),rectangle:e}),n=i(n,e),r(t.y+1)):r(t.y+1)}).catch(function(t){console.error(t)})},i=function(t,e){var n,r,a,i,h,o,c=0,s=0,l=0,u=0,g=0;for(h=t.linearArr.length,n=0;n<e.HTscore/500+1;n+=1)t.linearArr.push([e.y0,e.x0]);for(r=t.linearArr.length,n=0;n<r;n+=1)g+=t.linearArr[n][1];for(g=d(g/r),n=0;n<r;n+=1)o=t.linearArr[n][1],o+=o<g-.5?.5:o>g+.5?-.5:0,c+=t.linearArr[n][0]*o,u+=t.linearArr[n][0],s+=o,l+=t.linearArr[n][0]*t.linearArr[n][0];return c/=r,s/=r,u/=r,l/=r,l!==u*u&&h?(a=(c-s*u)/(l-u*u),a=(a*t.distances.length+Math.tan(t.theta))/(t.distances.length+1)):a=Math.tan(e.theta),i=s-a*u+a*t.y_shift-t.x_shift,t.m=a,t.intercept=i,t},h=function(t){var e,n,r,i,h,o=t.theta,c=t.x0,s=t.y0,l=t.width,u=t.height;return h=Math.ceil(100*(27.5-z.distance.constant)/(z.distance.width/l+z.distance.height/u))/100,e=Math.floor(1.15*u+s),r=Math.ceil(h*Math.cos(Math.min(Math.abs(o),Math.abs(Math.abs(o)-k)))+4),a=20+Math.tan(k+Math.abs(o))*r,n=Math.floor(c-l/2-a),i=Math.ceil(l+2*a),{x_shift_left:n,y_shift_down:e,topGreenY:s-1.15*u,width:i,height:r}},p=function(t,e,n,r){var a,i,h,o,c,s,l;for(r=r||1,h=Math.ceil(1.65*n.rect_width),a=Math.floor(t.x-h/2),c=Math.ceil(Math.sin(Math.abs(n.theta))*h/2+.25*n.rect_height)*r,i=t.y-c,o=Math.ceil(n.rect_height+2*c),s=[],a<0&&(h+=2*a,a=0),i<0&&(o+=2*i,i=0),o+i>n.y_max-1&&(i=o+2*i-(n.y_max-1),o=n.y_max-1-i),h+a>n.x_max-1&&(a=h+2*a-(n.x_max-1),h=n.x_max-1-a),l=a;l<h+a;l+=1)s.push([]),s[s.length-1]=e[l].slice(i,o+i);return{array:s,x_shift:a,y_shift:i}},s=function(t){return T.submit({array:t,non_maximum_suppression:1,for_hough:!1,roundDigit:1e4,minimum_edge:.05})},o=function(e,n,r,a){var h,o;e.end||(h=p(e,n,r),o={x0:h.array.length/2+r.x_shift+h.x_shift,y0:h.array[0].length/2+r.y_shift+h.y_shift,height:h.array[0].length,theta:0,width:h.array.length},c(o,"#FFFFCC",t),w.submit({array:h.array,roundDigit:1e4}).then(function(n){n.HTscore=d(n.HTscore/.05/10),n.HT_ret=JSON.parse(JSON.stringify(n)),n.x0+=r.x_shift+h.x_shift,n.y0+=r.y_shift+h.y_shift,n.width=((r.greenRectangleScore+r.rectangleScore)*r.rect_width+n.width*n.HTscore)/(r.rectangleScore+r.greenRectangleScore+n.HTscore),n.height=((r.greenRectangleScore+r.rectangleScore)*r.rect_height+n.height*n.HTscore)/(r.rectangleScore+r.greenRectangleScore+n.HTscore),n.theta=(r.rectangleScore*r.theta+n.theta*n.HTscore)/(r.rectangleScore+n.HTscore),r.rectangleScore+=n.HTscore,n.width=d(n.width),n.height=d(n.height),n.theta=d(n.theta),n.x0=d(n.x0),n.y0=d(n.y0),u(n,t).then(function(h){var s,l,u;if(l=Math.sqrt(Math.pow(n.y0-o.y0,2)+Math.pow(n.x0-o.x0,2)),u={avg:h.avg,median:h.median,horz:(n.HT_horz[0]+n.HT_horz[1])/n.width,vert:(n.HT_vert[0]+n.HT_vert[1])/n.height,avg_horz:-Math.log(h.avg/((n.HT_horz[0]+n.HT_horz[1])/n.width)),avg_vert:-Math.log(h.avg/((n.HT_vert[0]+n.HT_vert[1])/n.height)),med_horz:-Math.log(h.median/((n.HT_horz[0]+n.HT_horz[1])/n.width)),med_vert:-Math.log(h.median/((n.HT_vert[0]+n.HT_vert[1])/n.height))},(s=Object.keys(u).map(function(t){return u[t]*z.grey[t]}).reduce(function(t,e){return t+e})+z.grey.constant)>z.grey.minimum&&l<n.width){acceptedMedians.push([s,h.avg,h.median,n.HTscore]),r.rect_width=n.width,r.rect_height=n.height,r.theta=n.theta,n.greyScore=h,n.greyScore.checks=s,n.greyScore.check2=u,n.InitialParams=o,r=i(r,n);var g=c(n,"#FFA500",t);r.distances.push({distance:d(Math.sqrt(Math.pow(n.x0-r.x_origin,2)+Math.pow(n.y0-r.y_origin,2))),rectangle:n}),n.clear=g,a(Math.floor(n.y0-r.y_shift+r.rect_height))}else failedRects.push([s,h.avg,h.median,n.HTscore]),a(Math.floor(e.y+2))})}).catch(function(t){r.reject(new Error("Problem with finding grey bands"+t))}))},f=function(e,n,r,a){var i,h=.5;return i=function(n){for(var c,s,l,u=!1,d=0;!u&&n<r.y_max;){for(c=Math.round(n*r.m+r.intercept),t.fillStyle("#BE5A52"),t.fillRect(Math.round(c+r.x_shift),Math.round(n+r.y_shift),1,1),m(c+r.x_shift,n+r.y_shift,r.lane_number),s=0;s<1&&!u;s+=1)e[c+s]&&0===e[c+s][n].direction&&e[c+s][n].strength>0&&(u=!0,h=.95*(r.distances.length+1),o({x:c,y:n,end:!1},e,r,i));!u&&d>h*r.rect_width&&(u=!0,b({x:c,y:n,end:!1},e,r,i),h=1.5+.95*r.distances.length),n+=1,d+=1}if(!u){for(l=0;l<r.distances.length;l+=1)r.distances[l].rectangle.width=r.rect_width,r.distances[l].rectangle.height=r.rect_height;r.resolve({rect_height:r.rect_height,rect_width:r.rect_width,bands:r.distances,indicatorBand:a})}},new Promise(function(t,e){r.resolve=t,r.reject=e,i(n)})},l=function(t,e,n,r){return function(a){var h,o;return h=0,o={lane_number:r,x_shift:t.x_shift_left,y_shift:t.y_shift_down,x_center:e.x0,theta:e.theta,x_origin:e.x0,y_origin:e.y0,rect_width:e.width,rect_height:e.height,theta_origin:e.theta,y_max:a[0].length,x_max:a.length,rectangleScore:0,distances:[],greenRectangleScore:n,linearArr:[]},o=i(o,e),f(a,h,o,e)}},r=e.length,n=0;n<r;n+=1)P+=e[n].HTscore;return function(){var n,a;for(a=0;a<r;a+=1)S[a]=[],n=h(e[a]),R.min[0]=Math.min(n.x_shift_left,R.min[0]),R.min[1]=Math.min(n.topGreenY,R.min[1]),R.max[0]=Math.max(n.x_shift_left+n.width,R.max[0]),R.max[1]=Math.max(n.y_shift_down+n.height,R.max[1]),G.push(t.getGaus(t.getGrey,n.x_shift_left-1,n.y_shift_down-1,n.width+2,n.height+2).then(s).then(l(n,e[a],P,a)))}(),v={},v.lanePromise=Promise.all(G).then(function(e){var n,r,a,i,h,o,c,s,l=0,d=0,f=[],m=0,p=0,v=0,x=[];for(o=function(){var t,n,r=JSON.parse(JSON.stringify(e));for(t=0;t<r.length;t+=1)for(n=0;n<r[t].bands.length;n+=1)r[t].bands[n]||(r[t].bands.splice(n,1),n-=1);return r},y=function(n,l){var d;return d=Math.sqrt(Math.pow(e[n].indicatorBand.x0-l.x0,2)+Math.pow(e[n].indicatorBand.y0-l.y0,2)),i=Math.round(d*h+z.distance2.constant),a=e[n].bands.length,r=n,e[n].bands.push({distance:d,rectangle:l,call:i,change_call:c(r,a),remove:s(r,a)}),f[r].push(i),x[r][a]=[i,l.x0-p/2.2,l.y0-m/1.65,"Bold "+Math.round(2*m)+"px Georgia"],t.fillText(x[r][a][0],x[r][a][1],x[r][a][2],x[r][a][3],"#8A2BE2"),hcvGenie.genotype(f[r]).then(g(e[r])).then(function(){return u(l,t)}).then(function(t){var n,i,h;return h=e[r].bands[a].rectangle,i={avg:t.avg,median:t.median,horz:(h.HT_horz[0]+h.HT_horz[1])/h.width,vert:(h.HT_vert[0]+h.HT_vert[1])/h.height,avg_horz:-Math.log(t.avg/((h.HT_horz[0]+h.HT_horz[1])/l.width)),avg_vert:-Math.log(t.avg/((h.HT_vert[0]+h.HT_vert[1])/l.height)),med_horz:-Math.log(t.median/((h.HT_horz[0]+h.HT_horz[1])/l.width)),med_vert:-Math.log(t.median/((h.HT_vert[0]+h.HT_vert[1])/l.height))},n=Object.keys(i).map(function(t){return i[t]*z.grey[t]}).reduce(function(t,e){return t+e})+z.grey.constant,h.greyScore=t,h.greyScore.checks=n,h.greyScore.check2=i,e[r].bands[a].rectangle=h,e[r].bands[a]}).then(function(t){return M(o()),_(t,{lane_number:r},e[r])})},c=function(n,r){return function(a){var i,h=e[n].bands[r],c=[];for(h.call=a,f[n][r]=a,t.clearText(x[n][r][0],x[n][r][1],x[n][r][2],x[n][r][3]),x[n][r][0]=a,t.fillText(x[n][r][0],x[n][r][1],x[n][r][2],x[n][r][3],"#8A2BE2"),i=0;i<f[n].length;i+=1)f[n][i]&&c.push(f[n][i]);return hcvGenie.genotype(c).then(g(e[n])).then(function(t){return M(o()),t})}},s=function(n,r){return function(){var a,i=e[n].bands[r],h=[];for(i.rectangle.clear(),t.clearText(x[n][r][0],x[n][r][1],x[n][r][2],x[n][r][3]),delete e[n].bands[r],delete f[n][r],a=0;a<f[n].length;a+=1)f[n][a]&&h.push(f[n][a]);return hcvGenie.genotype(h).then(g(e[n])).then(function(t){return M(o()),t})}},r=0;r<e.length;r+=1)m+=(1+e[r].bands.length)*e[r].rect_height,p+=(1+e[r].bands.length)*e[r].rect_width,v+=1+e[r].bands.length;for(m/=v,p/=v,h=z.distance.width/p+z.distance.height/m,r=0;r<e.length;r+=1)for(n=(6.5-z.distance.constant)/h,a=0;a<e[r].bands.length;a+=1)e[r].bands[a].rectangle.bool&&e[r].bands[a].distance<n?(i=Math.round(e[r].bands[a].distance*h+z.distance.constant),l+=e[r].bands[a].distance/i,d+=1):e[r].bands[a].rectangle.bool||(e[r].bands.splice(a,1),a-=1);for(l/=d,h=z.distance2.width/p+z.distance2.height/m+z.distance2.sixScore/l,r=0;r<e.length;r+=1){for(f[r]=[],x[r]=[],a=0;a<e[r].bands.length;a+=1)i=Math.round(e[r].bands[a].distance*h+z.distance2.constant),e[r].bands[a].call=i,e[r].bands[a].change_call=c(r,a),e[r].bands[a].remove=s(r,a),_(e[r].bands[a],{lane_number:r},e[r]),f[r].push(i),x[r][a]=[i,e[r].bands[a].rectangle.x0-p/2.2,e[r].bands[a].rectangle.y0-m/1.65,"Bold "+Math.round(2*m)+"px Georgia"],t.fillText(x[r][a][0],x[r][a][1],x[r][a][2],x[r][a][3],"#8A2BE2");hcvGenie.genotype(f[r]).then(g(e[r]))}return{lanes:o,rect_width:p,rect_height:m,six_score:l,region:R}}),v.model_fit_data=function(){return v.lanePromise.then(function(e){var n,r,a,i,h,o,c,s,l,d=e.lanes(),g={x:0,y:0},f=[],m=[],_=[];for(c=function(t,e){return t.call-e.call},o=function(e,n,r,a){return Promise.all([t.getGaus(t.getGrey,Math.floor(e-2*r/2)-1,Math.floor(n-1.75*a/2)-1,Math.ceil(2*r)+2,Math.floor(1.75*a)+2).then(function(t){return T.submit({array:t,non_maximum_suppression:0,for_hough:!0,roundDigit:1e4,minimum_edge:.05})}).then(function(t){return w.submit(t)}),u({x0:e,y0:n,width:r,height:a},t)]).then(function(t){var e=t[0],n=t[1];return{avg:n.avg,median:n.median,horz:(e.HT_horz[0]+e.HT_horz[1])/r,vert:(e.HT_vert[0]+e.HT_vert[1])/a,avg_horz:-Math.log(n.avg/((e.HT_horz[0]+e.HT_horz[1])/r)),avg_vert:-Math.log(n.avg/((e.HT_vert[0]+e.HT_vert[1])/a)),med_horz:-Math.log(n.median/((e.HT_horz[0]+e.HT_horz[1])/r)),med_vert:-Math.log(n.median/((e.HT_vert[0]+e.HT_vert[1])/a))}})},l=function(){var t=0,e=0;for(n=0;n<d.length;n+=1)for(d[n].bands=d[n].bands.sort(c),r=0;r<d[n].bands.length-1;r+=1)d[n].bands[r].call<7&&(t+=d[n].bands[r].distance/d[n].bands[r].call,e+=1);return t/e},s=l(),n=0;n<d.length;n+=1)if(d[n].bands=d[n].bands.sort(c),d[n].bands.length>1){for(r=0;r<d[n].bands.length-1;r+=1)if(a=d[n].bands[r],m.push(a.rectangle.greyScore.check2),_.push([a.call,a.distance/e.rect_height,a.distance/e.rect_width,a.distance/s]),i=d[n].bands[r+1],i.call-a.call>1)for(h=Math.atan2(i.rectangle.y0-a.rectangle.y0,i.rectangle.x0-a.rectangle.x0),g.x=Math.cos(h)*e.rect_height+a.rectangle.x0,g.y=Math.sin(h)*e.rect_height+a.rectangle.y0;g.y<i.rectangle.y0-Math.sin(h)*e.rect_height;)f.push(o(g.x,g.y,e.rect_width,e.rect_height)),t.fillRect(g.x-1,g.y,3,1,"#228b22"),g.x+=Math.cos(h)*e.rect_height/1.5,g.y+=Math.sin(h)*e.rect_height/1.5;m.push(i.rectangle.greyScore.check2),_.push([i.call,i.distance/e.rect_height,i.distance/e.rect_width,i.distance/s])}else 1===d[n].bands.length&&(m.push(d[n].bands[0].rectangle.greyScore.check2),_.push([d[n].bands[0].call,d[n].bands[0].distance/e.rect_height,d[n].bands[0].distance/e.rect_width,d[n].bands[0].distance/s]));return Promise.all(f).then(function(t){var e,r,a,i,h=[],o=Object.keys(t[n]);for(a=function(e){return function(n){return t[e][n]}},i=function(t){return function(e){return m[t][e]}},e=0;e<t.length;e+=1)r=[0],h.push(r.concat(o.map(a(e))));for(e=0;e<m.length;e+=1)r=[1],h.push(r.concat(o.map(i(e))));return{grey_scores:{data:h,columns:["band"].concat(o)},distances:{data:_,columns:["call","dist_height","dist_width","dist_sixScore"]}}})})},v},n=function(t){return t.getLABcolorDist(0,0,t.width,t.height,S,2).then(function(e){var n,r,a=e.length,i=e[0].length,h=[[t.width,t.height],[0,0]];for(n=0;n<a;n+=1)for(r=0;r<i;r+=1)e[n][r]<15&&(posDistances.push(e[n][r]),h[0][0]=Math.min(2*n,h[0][0]),h[0][1]=Math.min(2*r,h[0][1]),h[1][0]=Math.max(2*n,h[1][0]),h[1][1]=Math.max(2*r,h[1][1]));return{xmin:h[0][0],ymin:h[0][1],width:h[1][0]-h[0][0]+1,height:h[1][1]-h[0][1]+1}})},e=function(t,e){return t.getLABcolorDist(e.xmin-5,e.ymin-5,e.width+10,e.height+10,S,1).then(function(n){var r,a,i,h,s,u,g,f,m,_,p,y,v,M=n.length,x=n[0].length,b=[],H=JSON.parse(JSON.stringify(n)),z=[],k=[],P=[],G=[],R=0,B=0,$=0;for(g=function(t,e){return t.x0=t.x0+e.xmin-3,t.y0=t.y0+e.ymin-3,t.HTscore=d(t.HTscore/10),R+=t.HTscore*t.width,B+=t.HTscore*t.height,$+=t.HTscore,t},v=function(t){return T.submit({array:t,non_maximum_suppression:0,for_hough:!0,roundDigit:1e4,minimum_edge:10})},_=function(t){return function(e){return w.submit(e).then(function(e){return g(e,t)})}},r=0;r<M;r+=1)for(a=0;a<x;a+=1)H[r][a]<15&&(i=o(H,r,a),k.push(i.height),P.push(i.width),z.push(i));for(h=l(k),s=l(P),u=0;u<z.length;u+=1)z[u].width>s/2&&z[u].height>h/4&&z[u].width<2*s&&z[u].height<4*h&&b.push({height:z[u].height,width:z[u].width,x0:z[u].width/2+z[u].xmin+e.xmin-5,y0:z[u].height/2+z[u].ymin+e.ymin-5,xmin:z[u].xmin+e.xmin-5,ymin:z[u].ymin+e.ymin-5,theta:0});for(u=0;u<b.length;u+=1)f=Math.floor(b[u].xmin-3),m=Math.ceil(b[u].width+6),p=Math.floor(b[u].ymin-3),y=Math.ceil(b[u].height+6),G.push(t.getGaus(t.getLABcolorDist,f-1,p-1,m+2,y+2,S).then(v).then(_(b[u])));return Promise.all(G).then(function(e){var n,r,a,i;for(r=d(B/$),a=d(R/$),u=0;u<e.length;u+=1)for(n=u+1;n<e.length;n+=1)e[u].x0<e[n].x0+a/2&&e[u].x0>e[n].x0-a/2&&(i=e[u].rectangleScore<e[n].rectangleScore?n:u,e.splice(i,1),n-=1);for(u=0;u<e.length;u+=1)e[u].height=r,e[u].width=a,c(e[u],"#6666ff",t);return e})})},o=function(t,e,n){var r,a,i,h,o,c,s,l,u,d,g,f,m,_={ys:[n],xs:[e]},p={},y={};for(t[e][n]=52.5,p[n]=[e,e],y[e]=[n,n],r=0;r<_.ys.length;r+=1)if(o=_.ys[r],h=_.xs[r],d=p[o][0]===h?1:0,g=y[h][0]===o?1:0,f=p[o][1]===h?1:0,m=y[h][1]===o?1:0,d+g+f+m>0)for(s=h-2*d,u=h+2*f,c=o-2*g,l=o+2*m,a=s;a<u+1;a+=1)for(i=c;i<l+1;i+=1)a>0&&i>0&&a<t.length&&i<t[a].length&&t[a][i]<15&&(_.ys.push(i),_.xs.push(a),t[a][i]=52.5,y[a]=y[a]||[i,i],p[i]=p[i]||[a,a],y[a][0]=i<y[a][0]?i:y[a][0],y[a][1]=i>y[a][1]?i:y[a][1],p[i][0]=a<p[i][0]?a:p[i][0],p[i][1]=a>p[i][1]?a:p[i][1]);return{xmin:Math.min.apply(null,_.xs),ymin:Math.min.apply(null,_.ys),width:Math.max.apply(null,_.xs)-Math.min.apply(null,_.xs)+1,height:Math.max.apply(null,_.ys)-Math.min.apply(null,_.ys)+1}},u=function(t,e){var n,r,a=t.x0,i=t.y0,h=t.width,o=t.height;return n=Math.floor(a-h/2),r=Math.floor(i-o/2),o=Math.ceil(o),h=Math.ceil(h),e.getGrey(n,r,h,o,1).then(v).then(function(t){return t})},v=function(t){var e,n,r,a=[],i=0,h=0;for(e=0;e<t.length;e+=1)for(n=0;n<t[0].length;n+=1)a.push(t[e][n]),h+=t[e][n],i+=1;return r=l(a),medianSignals.push([r,h/i,r*i/h]),r=r<.003?0:r*i/h,{median:r,avg:h/i}},i=function(t){var e,n,r,a={},i=t.getContext("2d"),h=i.getImageData(0,0,t.width,t.height).data,o={},c=$("<div>",{id:"mynewdiv"});c.css("position","relative"),c.append($(t)),$(t).attr("id","mainOne"),$(t).css("z-index",1),$(t).css("position","absolute"),$(t).css("left","0px"),$(t).css("top","0px"),$(t).css("width","100%");var s=$("<canvas>",{id:"drawingCanvas"});return s.appendTo(c),s[0].height=t.height,s[0].width=t.width,s.css("z-index",2),s.css("position","absolute"),s.css("left","0px"),s.css("top","0px"),s.css("width","100%"),e=s[0].getContext("2d"),n=function(t){var e,n,a,i,h,o,c,s,l,u=[];for(a=t.length,i=t[0].length,e=2;e<a-2;e+=1)for(u.push([]),n=2;n<i-2;n+=1){for(l=0,o=0,c=-2;c<3;c+=1)for(s=-2;s<3;s+=1)t[e+c][n+s]&&(h=r(c,s),l+=h*t[e+c][n+s],o+=h);u[e-2].push(Math.round(1e4*l/o)/1e4)}return u},r=function(t,e){var n=Math.abs(e)+Math.abs(t);return 4===n?2:3===n?4:2!==n||0!==t&&0!==e?2===n?9:1===n?12:15:5},a.getRGB=function(e,n,r,a,i){var o,c,s,l=[],u=0;for(i=i||1,o=e;o<e+r;o+=i){for(l[u]=[],c=n;c<n+a;c+=i)s=4*(o+t.width*c),l[u].push([h[s],h[s+1],h[s+2]]);u+=1}return Promise.resolve(l)},a.getLABcolorDist=function(t,e,n,r,i,h){return h=h||1,new Promise(function(c,s){var l,u,d,g,f,m,_,p,y=[],v=[],M=75*h;if(p=i.join("-"),o.hasOwnProperty(p)||(o[p]={}),n*r/h/h>22500){for(u=Math.ceil(n/M),d=Math.ceil(r/M),l=0;l<u*d;l+=1)m=t+l%u*M,_=e+Math.floor(l/u)*M,g=Math.min(M,n-m+t),f=Math.min(M,r-_+e),v.push([m-t,_-e]),y.push(a.getLABcolorDist(m,_,g,f,i,h));Promise.all(y).then(function(t){var e,n,r,a=[];for(e=0;e<t.length;e+=1)if(0===v[e][1])for(n=0;n<t[e].length;n+=1)a.push(t[e][n]);else for(n=0;n<t[e].length;n+=1)for(r=0;r<t[e][n].length;r+=1)a[n+v[e][0]/h].push(t[e][n][r]);c(a)}).catch(function(t){console.error(t),s(new Error("Error with getting RBG Quilted",t))})}else a.getRGB(t,e,n,r,h).then(function(a){var l,u,d;for(u=0;u<n;u+=h)for(d=0;d<r;d+=h)l=t+u*h+"_"+(e+d*h),o[p].hasOwnProperty(l)&&(a[u/h][d/h]=o[p][l]);b.submit({arr:a,col:i,roundDigit:1e4}).then(function(a){for(n=a.length,r=a[0].length,u=0;u<n;u+=1)for(d=0;d<r;d+=1)l=t+u*h+"_"+(e+d*h),o[p].hasOwnProperty(l)||(o[p][l]=a[u][d]);c(a)}).catch(function(t){s(new Error("Error with workers",t))})}).catch(function(t){s(new Error("Error with getting RBG",t))})})},a.getGaus=function(t,e,r,a,i,h){return t(e-2,r-2,a+4,i+4,h).then(n)},a.getGrey=function(t,e,n,r,i){return i=i||1,a.getRGB(t,e,n,r,i).then(function(t){var e,a,i;for(n=t.length,r=t[0].length,e=0;e<n;e+=1)for(a=0;a<r;a+=1)i=t[e][a],t[e][a]=d(.21*(1-i[0]/255)+.72*(1-i[1]/255)+.07*(1-i[2]/255));return t})},a.height=t.height,a.width=t.width,a.fillStyle=function(t){e.fillStyle=t},a.fillRect=function(t,n,r,a,i){i&&(e.fillStyle=i),e.fillRect(t,n,r,a)},a.fillRect=function(t,n,r,a,i){i&&(e.fillStyle=i),e.fillRect(t,n,r,a)},a.fillText=function(t,n,r,a,i){i&&(e.fillStyle=i),a&&(e.font=a),e.fillText(t,n,r)},a.clearText=function(t,n,r,a){var i=e.globalCompositeOperation;e.globalCompositeOperation="destination-out",a&&(e.font=a),e.fillStyle="#ffffff",e.fillText(t,n,r),e.globalCompositeOperation=i},a.clearRect=function(t,n,r,a){e.clearRect(t,n,r,a)},a.canvasHolder=c,a},s=function(t,e){return e-t},r=function(t,e,n,r){return function(a){return a.getPage(t.image.pageNumber).then(function(t){var a,i,h;return i=r||2.25,console.log("PDF Scale",i),a=t.getViewport(i),e.height=a.height,e.width=a.width,h={canvasContext:n,viewport:a},t.render(h).then(function(){return e})})}},h=function(){var t,e,n,r,a,i,o,s={},l={},d=0,g=0,p=1e-50,v=!1;t=function(t,e){var n=t.getBoundingClientRect(),r=t.width/n.width,a=t.height/n.height;return{x:(e.clientX-n.left)*r,y:(e.clientY-n.top)*a}},h=function(){s={},l={},d=0,g=0,p=1e-50,v=!1},m=function(t,e,n){var r=Math.round(t),a=Math.round(e);s[r]=s[r]||{},s[r][a]=[{x0:t,y0:e,lane_number:n,edges:function(t,e,n,r){return o.getGaus(o.getGrey,Math.floor(n-2*t/2)-1,Math.floor(r-1.75*e/2)-1,Math.ceil(2*t)+2,Math.floor(1.75*e)+2).then(function(t){return T.submit({array:t,non_maximum_suppression:0,for_hough:!0,roundDigit:1e4,minimum_edge:.05})}).then(function(t){return w.submit(t)}).then(function(a){return a.x0=Math.floor(n-2*t/2)+a.x0,a.y0=Math.floor(r-1.75*e/2)+a.y0,a.width=t,a.height=e,a})}}]},e=function(t){var e,n,r,a,i,h,o,c,u,f=[],m=1/0;for(i=Math.round(t.x),h=Math.round(t.y),c=d/p,u=g/p,e=Math.floor(i-c);Math.ceil(e<i+c+1);e+=1)for(n=Math.floor(h-2*u);n<Math.ceil(h+2*u+1);n+=1)l[e]&&l[e][n]?f.push(l[e][n]):s[e]&&s[e][n]&&f.push(s[e][n]);for(r=0;r<f.length;r+=1)o=Math.sqrt(Math.pow(t.x-f[r][0].x0,2)+Math.pow(t.y-f[r][0].y0,2)),2===f[r].length&&(o-=Math.sqrt(Math.pow(g/p/2,2)+Math.pow(d/p/2,2)),o/=2.5),o<m&&(a=r,m=o);return void 0!==a?f[a]:void 0},_=function(t,e,n){var r,a,i;return i=t.rectangle,i.lane_number=e.lane_number,r=Math.round(i.x0),a=Math.round(i.y0),g+=i.height,d+=i.width,p+=1,l[r]=l[r]||{},l[r][a]=[i,t,n],l[r][a]},n=function(t){return a.title("Band"),a.body("<p>Lane: "+(t[0].lane_number+1)+'</p><p>Band Call: <span id="band_call_modal">'+t[1].call+'</span>&nbsp;&nbsp;&nbsp;Update Band Call: <input id="update_call_img"></input></p><p>Genotype: <span id="genotype_call_modal"></span></p><p>Greyness: (median) '+t[0].greyScore.median.toFixed(3)+", (average) "+t[0].greyScore.avg.toFixed(3)+"</p><p>Horizontal Edge Strength: "+t[0].greyScore.check2.horz.toFixed(3)+"</p><p>Verticle Edge Strength: "+t[0].greyScore.check2.vert.toFixed(3)+"</p><p>Ratios (avg/vert, avg/horz, med/vert, med/horz): "+t[0].greyScore.check2.avg_vert.toFixed(3)+", "+t[0].greyScore.check2.avg_horz.toFixed(3)+", "+t[0].greyScore.check2.med_vert.toFixed(3)+", "+t[0].greyScore.check2.med_horz.toFixed(3)+"</p>"),$("#genotype_call_modal").text(t[2].genotype),$("#update_call_img").on("change",function(e){e.preventDefault();var n=t[1].change_call(1*e.currentTarget.value);$("#band_call_modal").text(e.currentTarget.value),n.then(function(t){$("#genotype_call_modal").text(t)})}),a.footer().unbind("click").html("Remove Band").click(function(){var e=t[1].remove();a.modal("toggle"),delete l[Math.round(t[0].x0)][Math.round(t[0].y0)],e.then(function(t){$("#genotype_call_modal").text(t)})}),a.modal("toggle"),setTimeout(function(){$("#update_call_img").focus()},500),t},r=function(t,e){var r;a.title("Add band?"),a.body('<span id="transform_modal">Applying Hough Transform, please wait...</span>'),a.footer().unbind("click").html("Add Band"),a.modal("toggle"),t[0].edges(d/p,g/p,e.x,e.y).then(function(t){return r=t,u(r,o)}).then(function(e){var i,h,s;return s=r,h={avg:e.avg,median:e.median,horz:(s.HT_horz[0]+s.HT_horz[1])/s.width,vert:(s.HT_vert[0]+s.HT_vert[1])/s.height,avg_horz:-Math.log(e.avg/((s.HT_horz[0]+s.HT_horz[1])/r.width)),avg_vert:-Math.log(e.avg/((s.HT_vert[0]+s.HT_vert[1])/r.height)),med_horz:-Math.log(e.median/((s.HT_horz[0]+s.HT_horz[1])/r.width)),med_vert:-Math.log(e.median/((s.HT_vert[0]+s.HT_vert[1])/r.height))},i=Object.keys(h).map(function(t){return h[t]*z.grey[t]}).reduce(function(t,e){return t+e})+z.grey.constant,a.body("<p>This proposed rectangle for lane "+(t[0].lane_number+1)+" has a grey score of: "+i.toFixed(3)+". This can be compared to the current minimum: "+z.grey.minimum+".</p>"),a.footer().click(function(e){e.preventDefault(),a.footer().off(),s.clear=c(s,"#FFA500",o),a.modal("toggle"),y(t[0].lane_number,s).then(function(t){setTimeout(function(){n(t)},500)})}),s})},i=function(){a=$("<div>",{class:"modal fade",tabindex:"-1",role:"dialog"});var t=$("<div>",{class:"modal-dialog",role:"document"}),e=$("<div>",{class:"modal-content"}),n=$("<div>",{class:"modal-header",html:'<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'}),r=$("<div>",{class:"modal-title"}),h=$("<div>",{class:"modal-body",style:"word-break:break-all;"}),o=$("<div>",{class:"modal-footer",html:'<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>'}),c=$("<button>",{class:"btn btn-primary"});e.append(n.append(r)),e.append(h),e.append(o.append(c)),e.appendTo(t.appendTo(a)),a.appendTo($("body")),a.title=function(t){r.html(t)},a.body=function(t){h.html(t)},a.footer=function(){return c},i=function(){}},f=function(a,h){return function(c){var s,l;if(c.preventDefault(),!v)return v=!0,o=h,i(),s=t(a,c),l=e(s),l&&(l.length>2?n(l):r(l,s)),setTimeout(function(){v=!1},50),s}}},a=function(r){var a,h,o;return a=i(r),$(r).parent().click(f(r,a)),$(r).parent().children().click(f(r,a)),h=n(a).then(function(t){return e(a,t)}),o=h.then(function(e){return t(a,e)}),{canvas:$(r).parent(),bandingPromise:o,canvasObject:a}},d=function(t){return Math.round(1e4*t)/1e4},function(t){return b.clear_jobs(),w.clear_jobs(),H.clear_jobs(),T.clear_jobs(),h(),M=t.onchange&&"function"==typeof t.onchange?t.onchange:function(){},new Promise(function(e,n){var i,h,o,c;c=t.image.scale||2.25,i=document.createElement("canvas"),h=i.getContext("2d"),o="pdf"===t.image.type?PDFJS.getDocument(t.image.url).then(r(t,i,h,c)):new Promise(function(e,n){var r;r=new Image,r.onload=function(){i.width=r.width,i.height=r.height,h.drawImage(r,0,0,r.width,r.height),e(i)},r.onerror=function(t){n(new Error(t))},r.src=t.image.url}),o.then(a).then(function(t){t.error?n(new Error(t)):e(t)})})}}(),hcvGenie.genotype=function(){"use strict";var t=new Promise(function(t,e){var n=new XMLHttpRequest;n.overrideMimeType("application/json"),n.open("GET","./json/genotypesCurrent.json",!0),n.onreadystatechange=function(){4===n.readyState&&200===n.status?t(JSON.parse(n.responseText)):4===n.readyState&&e(n.responseText+"Could not get database")},n.onerror=function(){e(n.responseText+"Could not get database")},n.send(null)});return function(e){var n=["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"];return t.then(function(t){var r,a,i,h;for(r=0;r<e.length;r+=1)(a=parseInt(e[r]))&&!isNaN(a)&&a>2&&a<27&&(n[a-3<20?a-3:a-4]="1");return i=parseInt(n.join(""),2).toString(36),t.hasOwnProperty(i)?(h=t[i].replace(/\*/g,", but the possibility of G 6 (subtypes c-l) cannot be excluded"),h=h.replace(/G/g,"Genotype ")):h="Unknown Band Pattern",h})}}();